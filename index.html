<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Precifica√ß√£o MDF + Laser</title>
  <style>
    :root {
      --bg:#f4eee8; --card:#fffdfb; --muted:#9c8978; --text:#5b4a3f;
      --accent:#a4ad8f; --accent2:#d2b39a; --danger:#cf9a9a; --border:#e5d8cc;
      --shadow:0 14px 30px rgba(152,126,104,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial; background:radial-gradient(circle at top,#f9f5f1,var(--bg) 70%); color:var(--text); padding:24px 12px 40px;}
    .app-shell{max-width:1220px; margin:0 auto; background:rgba(255,250,246,.85); border:1px solid #efe4db; border-radius:28px; box-shadow:var(--shadow); overflow:hidden; backdrop-filter:blur(6px);}
    header{padding:22px 28px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:12px; background:rgba(252,247,242,.92);}
    .brand{display:flex; align-items:center; gap:16px;}
    .logo-mark{width:58px; height:58px; border-radius:18px; background:linear-gradient(145deg,#ecd7c7,#f8efe8); color:#b99075; font-size:28px; display:grid; place-items:center; font-weight:700; box-shadow:inset 0 1px 0 #fff;}
    header h1{margin:0;font-size:37px;font-weight:500; letter-spacing:.3px; color:#8d705d;}
    header p{margin:2px 0 0; color:var(--muted); font-size:13px}
    .top-actions{display:flex; gap:10px; align-items:center;}
    .ghost-btn{border:1px solid var(--border); border-radius:14px; background:#fffcf9; padding:10px 14px; color:#8d705d; font-weight:600; box-shadow:0 2px 8px rgba(168,138,114,.1);}
    .profile{width:44px; height:44px; border-radius:50%; background:#b9c1aa; color:#fff; display:grid; place-items:center; font-weight:700;}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; padding:10px 20px; border-bottom:1px solid var(--border); background:#fffdfa;}
    .tab{border:1px solid transparent; background:transparent; color:#8f7a69; padding:11px 16px; border-radius:12px; cursor:pointer; font-weight:600; font-size:21px;}
    .tab.active{color:#6e8a63; background:#f6f1ec; border-color:#e8ddd2;}
    .wrap{padding:20px 18px 34px;}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start;}
    @media (max-width: 920px){ .grid{grid-template-columns: 1fr;} }
    .card{background:var(--card); border:1px solid var(--border); border-radius:20px; padding:16px; box-shadow:0 8px 20px rgba(162,132,106,.1);}
    .card h2{margin:0 0 10px; font-size:15px}
    .muted{color:var(--muted); font-size:12px; line-height:1.35}
    .row{display:grid; grid-template-columns: 1fr 200px; gap:10px; margin:10px 0; align-items:center;}
    @media (max-width: 520px){ .row{grid-template-columns:1fr;} }
    label{font-size:13px; font-weight:600}
    input, select, textarea{width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--border); background:#fffdfa; color:var(--text); outline:none;}
    input:focus, select:focus, textarea:focus{border-color:#d9beaa; box-shadow:0 0 0 3px rgba(223,197,176,.3);}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button.btn{padding:10px 14px; border-radius:12px; border:1px solid var(--border); cursor:pointer; font-weight:700; background:#f9f2ec; color:#7b6555;}
    button.btn.primary{background:#a8b196; color:#fff; border-color:#98a188;}
    button.btn.accent{background:#e9d5c4; border-color:#dfc2aa;}
    button.btn.danger{background:#f6e7e6; border-color:#eac6c6; color:#ad6d6d;}
    .kpis{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px;}
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr;} }
    .kpi{padding:12px; border-radius:16px; border:1px solid var(--border); background:#fff9f4;}
    .kpi .t{font-size:12px; color:var(--muted);}
    .kpi .v{font-size:20px; font-weight:800; margin-top:6px; letter-spacing:.2px}
    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; border:1px solid var(--border);}
    .table th,.table td{padding:10px; font-size:13px; border-bottom:1px solid var(--border);}
    .table th{text-align:left; color:var(--muted); background:#fcf7f2; font-weight:700}
    .table tr:last-child td{border-bottom:none}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted);}
    .right{text-align:right}
    .hide{display:none}
    .note{padding:10px 12px; border:1px dashed #decab8; border-radius:14px; background:#fff8f1; color:#8f7563; font-size:12px; line-height:1.4;}
    .footer{margin-top:16px; color:var(--muted); font-size:12px}
    a{color:#8f7a69}
    .manual h2{font-size:22px; color:#7b6555; margin:0 0 8px;}
    .manual h3{font-size:17px; color:#8d705d; margin:16px 0 8px;}
    .manual p,.manual li{font-size:14px; line-height:1.5; color:#6f5b4f;}
    .manual ul,.manual ol{margin:8px 0 0 20px; padding:0;}
    .manual .checklist{display:grid; gap:8px; margin-top:10px;}
    .manual .check{background:#f9f2ec; border:1px solid var(--border); border-radius:12px; padding:8px 10px; font-weight:600; color:#7b6555;}
    button.btn.primary.terracota{background:#c68463;border-color:#b97858;color:#fff;}
    #catalogTable tbody tr.selected{background:#f7ece5;}
    @media (max-width: 880px){
      header{flex-direction:column; align-items:flex-start;}
      header h1{font-size:28px;}
      .top-actions{width:100%;}
      .ghost-btn{flex:1;}
      .tab{font-size:18px;}
    }
  </style>
</head>
<body>
<div class="app-shell">
<header>
  <div class="brand">
    <div class="logo-mark">M</div>
    <div>
      <h1>Sistema de Precifica√ß√£o MM Decor</h1>
      <p>Visual suave e organizado para uso di√°rio no simulador, par√¢metros e produtos.</p>
    </div>
  </div>
  <div class="top-actions">
    <button class="ghost-btn" type="button">Exportar CSV</button>
    <button class="ghost-btn" type="button">Conta</button>
    <div class="profile">M</div>
  </div>
</header>

<div class="tabs">
  <button class="tab active" data-tab="sim">Simulador</button>
  <button class="tab" data-tab="madeiras">Madeiras</button>
  <button class="tab" data-tab="param">Par√¢metros</button>
  <button class="tab" data-tab="prod">Produtos</button>
  <button class="tab" data-tab="manual">Manual</button>
  <button class="tab" data-tab="backup">Backup</button>
</div>

<div class="wrap">

  <!-- SIMULADOR -->
  <section id="tab-sim">
    <div class="grid">
      <div class="card">
        <h2>Simulador (1 produto)</h2>
        <div class="muted">Preencha os campos. Use <b>Comprimento √ó Largura</b> OU <b>% da chapa</b>. Se preencher os dois, o sistema usa <b>% da chapa</b>.</div>

        <div class="row">
          <label>Nome do produto</label>
          <input id="sim_nome" type="text" placeholder="Ex.: Display Alga 60cm" />
        </div>

        <div class="row">
          <label>SKU</label>
          <input id="sim_sku" type="text" placeholder="Ex.: ALG-60-6MM" />
        </div>

        <div class="row">
          <label>Madeira selecionada</label>
          <select id="sim_wood"></select>
        </div>

        <div class="row">
          <label>Comprimento da pe√ßa (cm)</label>
          <input id="sim_comp" type="number" step="0.01" placeholder="Ex.: 20" />
        </div>

        <div class="row">
          <label>Largura da pe√ßa (cm)</label>
          <input id="sim_larg" type="number" step="0.01" placeholder="Ex.: 15" />
        </div>

        <div class="row">
          <label>% da chapa (opcional)</label>
          <input id="sim_pct" type="number" step="0.01" placeholder="Ex.: 12,5" />
        </div>

        <div class="row">
          <label>Tempo de corte (min)</label>
          <input id="sim_corte" type="number" step="0.01" />
        </div>

        <div class="row">
          <label>Tempo de grava√ß√£o (min) (opcional)</label>
          <input id="sim_grav" type="number" step="0.01" />
        </div>

        <div class="row">
          <label>Tempo de montagem/acabamento (min)</label>
          <input id="sim_mont" type="number" step="0.01" />
        </div>

        <div class="row">
          <label>Canal</label>
          <select id="sim_canal">
            <option>Shopee</option>
            <option>Mercado Livre</option>
            <option>TikTok</option>
          </select>
        </div>

        <div class="row">
          <label>Margem desejada (%) (opcional)</label>
          <input id="sim_margem" type="number" step="0.01" placeholder="Se vazio, usa a margem padr√£o em Par√¢metros" />
        </div>

        <div class="btnbar">
          <button class="btn accent" id="btnRecalcular">Recalcular</button>
          <button class="btn primary" id="btnSalvarProduto">Salvar produto</button>
          <button class="btn" id="btnLimpar">Limpar campos</button>
        </div>

        <div class="footer">Dica: edite Madeiras/Par√¢metros para refletir sua opera√ß√£o. O c√°lculo replica a l√≥gica da planilha.</div>
      </div>

      <div class="card">
        <h2>Resultado</h2>
        <div class="note" id="noteWood">‚Äî</div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Custo total (R$)</div>
            <div class="v" id="k_custo_total">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Pre√ßo sugerido (R$)</div>
            <div class="v" id="k_preco">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Lucro l√≠quido estimado (R$)</div>
            <div class="v" id="k_lucro">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Margem l√≠quida estimada</div>
            <div class="v" id="k_margem_liq">‚Äî</div>
          </div>
        </div>

        <h2 style="margin-top:14px;">Detalhamento</h2>
        <table class="table">
          <tbody>
            <tr><td>Custo MDF da pe√ßa</td><td class="right" id="d_mdf">‚Äî</td></tr>
            <tr><td>Custo laser</td><td class="right" id="d_laser">‚Äî</td></tr>
            <tr><td>Custo m√£o de obra</td><td class="right" id="d_mao">‚Äî</td></tr>
            <tr><td>Overhead</td><td class="right" id="d_over">‚Äî</td></tr>
            <tr><td>Embalagem</td><td class="right" id="d_emb">‚Äî</td></tr>
            <tr><td><b>Custo base</b></td><td class="right" id="d_base">‚Äî</td></tr>
            <tr><td>Ajuste perdas/retrabalho</td><td class="right" id="d_perdas">‚Äî</td></tr>
            <tr><td><b>Taxa do canal</b></td><td class="right" id="d_taxa">‚Äî</td></tr>
            <tr><td><b>Margem usada</b></td><td class="right" id="d_margem_used">‚Äî</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- MADEIRAS -->
  <section id="tab-madeiras" class="hide">
    <div class="card">
      <h2>Cadastro de Madeiras</h2>
      <div class="muted">Voc√™ pode adicionar/editar/remover materiais. Isso impacta o Simulador.</div>

      <div class="btnbar">
        <button class="btn primary" id="btnAddWood">Adicionar madeira</button>
        <span class="pill">Tudo salva automaticamente</span>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table class="table" id="woodsTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th class="right">Esp. (mm)</th>
              <th class="right">Larg. (cm)</th>
              <th class="right">Alt. (cm)</th>
              <th class="right">Pre√ßo chapa (R$)</th>
              <th class="right">√Årea chapa (m¬≤)</th>
              <th class="right">Custo (R$/m¬≤)</th>
              <th>Obs.</th>
              <th class="right">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer">C√°lculos autom√°ticos: √Årea (m¬≤) = (largura√óaltura)/10000; Custo/m¬≤ = pre√ßo/√°rea.</div>
    </div>
  </section>

  <!-- PARAMETROS -->
  <section id="tab-param" class="hide">
    <div class="grid">
      <div class="card">
        <h2>Par√¢metros Gerais</h2>

        <div class="row"><label>Custo hora laser (R$/h)</label><input id="p_laser" type="number" step="0.01" /></div>
        <div class="row"><label>Custo m√£o de obra (R$/h)</label><input id="p_mao" type="number" step="0.01" /></div>
        <div class="row"><label>Overhead por pe√ßa (R$)</label><input id="p_over" type="number" step="0.01" /></div>
        <div class="row"><label>Embalagem por pe√ßa (R$)</label><input id="p_emb" type="number" step="0.01" /></div>
        <div class="row"><label>Retrabalho/perdas (%)</label><input id="p_perdas" type="number" step="0.01" /></div>
        <div class="row"><label>Margem padr√£o (l√≠quida) (%)</label><input id="p_margem" type="number" step="0.01" /></div>

        <div class="btnbar">
          <button class="btn accent" id="btnSalvarParams">Salvar par√¢metros</button>
        </div>

        <div class="footer">A margem padr√£o s√≥ √© usada quando a Margem do Simulador estiver vazia.</div>
      </div>

      <div class="card">
        <h2>Canais & Taxas</h2>
        <div class="row"><label>Shopee - Taxa (%)</label><input id="p_tax_shopee" type="number" step="0.01" /></div>
        <div class="row"><label>Mercado Livre - Taxa (%)</label><input id="p_tax_ml" type="number" step="0.01" /></div>
        <div class="row"><label>TikTok - Taxa (%)</label><input id="p_tax_tt" type="number" step="0.01" /></div>

        <div class="note">Dica: se o seu canal tiver taxa fixa + vari√°vel, voc√™ pode embutir a taxa fixa no Overhead/Embalagem e deixar aqui s√≥ a parte percentual.</div>
      </div>
    </div>
  </section>


  <!-- PRODUTOS -->
  <section id="tab-prod" class="hide">
    <div class="grid">
      <div class="card">
        <h2>Lista de Produtos</h2>
        <div class="row"><label>Busca (Nome / SKU / categoria / espessura / canal)</label><input id="prod_search" type="text" placeholder="Digite para filtrar" /></div>
        <div class="row"><label>Status</label><select id="prod_filter_status"><option value="all">Todos</option><option value="active">Ativo</option><option value="inactive">Inativo</option></select></div>
        <div class="row"><label>Categoria</label><input id="prod_filter_categoria" type="text" placeholder="Ex.: Festa" /></div>
        <div class="row"><label>Espessura (mm)</label><input id="prod_filter_esp" type="number" step="1" placeholder="Ex.: 6" /></div>
        <div class="row"><label>Canal padr√£o</label><select id="prod_filter_canal"><option value="all">Todos</option><option>Shopee</option><option>Mercado Livre</option><option>TikTok</option></select></div>
        <div class="row"><label>Ordenar por</label><select id="prod_sort"><option value="recent">Mais recentes</option><option value="lucro">Maior lucro</option><option value="margem">Maior margem</option><option value="mais_vendidos">Mais vendidos</option></select></div>
        <div class="btnbar"><button class="btn" id="prod_refresh">Atualizar lista</button><button class="btn" id="prod_batch_recalc">Recalcular em lote</button><button class="btn danger" id="prod_archive_selected">Arquivar selecionados</button></div>
        <div style="margin-top:12px; overflow:auto;">
          <table class="table" id="catalogTable">
            <thead><tr><th></th><th>Nome</th><th>SKU</th><th>MDF/Esp.</th><th>Canal</th><th class="right">Custo total</th><th class="right">Pre√ßo sugerido</th><th class="right">Lucro</th><th class="right">Margem</th><th>Status</th><th class="right">A√ß√µes</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Ficha T√©cnica + Precifica√ß√£o</h2>
        <div class="row"><label>Nome*</label><input id="pf_nome" type="text" /></div>
        <div class="row"><label>SKU*</label><input id="pf_sku" type="text" /></div>
        <div class="row"><label>Categoria</label><input id="pf_categoria" type="text" /></div>
        <div class="row"><label>Tags (v√≠rgula)</label><input id="pf_tags" type="text" /></div>
        <div class="row"><label>Ativo</label><select id="pf_ativo"><option value="true">Ativo</option><option value="false">Inativo</option></select></div>
        <div class="row"><label>Madeira</label><select id="pf_wood"></select></div>
        <div class="row"><label>Espessura (mm)</label><input id="pf_esp" type="number" /></div>
        <div class="row"><label>Qtd de pe√ßas por produto</label><input id="pf_qtd_pecas" type="number" step="1" placeholder="Ex.: 3" /></div>
        <div class="row"><label>Comprimento (cm)</label><input id="pf_comp" type="number" step="0.01" /></div>
        <div class="row"><label>Largura (cm)</label><input id="pf_larg" type="number" step="0.01" /></div>
        <div class="row"><label>% da chapa (override)</label><input id="pf_pct" type="number" step="0.01" /></div>
        <div class="row"><label>Tempo corte (min)</label><input id="pf_tc" type="number" step="0.01" /></div>
        <div class="row"><label>Tempo grava√ß√£o (min)</label><input id="pf_tg" type="number" step="0.01" /></div>
        <div class="row"><label>Tempo montagem (min)</label><input id="pf_tm" type="number" step="0.01" /></div>
        <div class="row"><label>Tempo pintura/acabamento (min)</label><input id="pf_tp" type="number" step="0.01" /></div>
        <div class="row"><label>Canal padr√£o</label><select id="pf_canal"><option>Shopee</option><option>Mercado Livre</option><option>TikTok</option></select></div>
        <div class="row"><label>Margem desejada (%)</label><input id="pf_margem" type="number" step="0.01" /></div>
        <div class="row"><label>Arquivo de corte (nome/url/vers√£o)</label><input id="pf_arquivo" type="text" placeholder="nome | url | v1" /></div>
        <div class="row"><label>Vers√£o do arquivo (data)</label><input id="pf_arquivo_data" type="date" /></div>
        <div class="row"><label>Observa√ß√µes t√©cnicas</label><textarea id="pf_obs" rows="2"></textarea></div>
        <div class="row"><label>Checklist de qualidade (pontos cr√≠ticos)</label><textarea id="pf_qualidade" rows="2" placeholder="Pe√ßa delicada, verificar bordas..."></textarea></div>
        <div class="row"><label>Insumos (nome|un|qtd|custo unit por linha)</label><textarea id="pf_insumos" rows="3" placeholder="cola|ml|10|0.03"></textarea></div>
        <div class="row"><label>Embalagem (tipo|custo)</label><input id="pf_emb" type="text" placeholder="caixa|1.50" /></div>
        <div class="row"><label>Dimens√£o embalagem (opcional)</label><input id="pf_emb_dim" type="text" placeholder="30x20x8 cm" /></div>
        <div class="btnbar">
          <button class="btn primary terracota" id="pf_calcular">Calcular</button>
          <button class="btn accent" id="pf_salvar">Salvar</button>
          <button class="btn" id="pf_duplicar">Duplicar</button>
          <button class="btn danger" id="pf_arquivar">Arquivar</button>
          <button class="btn" id="pf_novo">Novo</button>
        </div>
        <div class="kpis">
          <div class="kpi"><div class="t">Custo total</div><div class="v" id="pf_k_custo">‚Äî</div></div>
          <div class="kpi"><div class="t">Pre√ßo sugerido</div><div class="v" id="pf_k_preco">‚Äî</div></div>
          <div class="kpi"><div class="t">Lucro</div><div class="v" id="pf_k_lucro">‚Äî</div></div>
          <div class="kpi"><div class="t">Margem l√≠quida</div><div class="v" id="pf_k_margem">‚Äî</div></div>
        </div>
        <h2 style="margin-top:14px;">Hist√≥rico de pre√ßo</h2>
        <div id="pf_history" class="note">Sem revis√µes ainda.</div>
      </div>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="tab-manual" class="hide">
    <div class="card manual">
      <h2>üìò MANUAL COMPLETO</h2>
      <p><strong>Sistema de Precifica√ß√£o MM Decor</strong><br />Precifica√ß√£o Profissional MDF + Laser.</p>

      <div class="checklist">
        <div class="check">‚úÖ Custo de m√£o de obra</div>
        <div class="check">‚úÖ Ajuste de perdas / retrabalho</div>
        <div class="check">‚úÖ Overhead</div>
        <div class="check">‚úÖ % da chapa (opcional)</div>
      </div>

      <h3>üéØ 1. Objetivo do Sistema</h3>
      <p>O sistema calcula custo real de produ√ß√£o, custo completo (direto + indireto), pre√ßo ideal de venda, lucro real por unidade e margem l√≠quida ap√≥s taxas. Ele evita venda abaixo do custo real.</p>

      <h3>üß≠ 2. Estrutura do Sistema</h3>
      <p>O sistema possui 4 √°reas principais: <strong>Simulador</strong>, <strong>Madeiras</strong>, <strong>Par√¢metros</strong> e <strong>Produtos</strong>.</p>

      <h3>ü™µ 3. Aba MADEIRAS</h3>
      <ul>
        <li><strong>Nome da Madeira:</strong> identifica√ß√£o do material (ex.: MDF 6mm Cru).</li>
        <li><strong>Largura da Chapa (cm):</strong> medida horizontal da chapa inteira.</li>
        <li><strong>Altura da Chapa (cm):</strong> medida vertical da chapa inteira.</li>
        <li><strong>Valor da Chapa (R$):</strong> valor total pago pela chapa.</li>
      </ul>
      <p>O sistema calcula automaticamente √°rea total da chapa e custo por cm¬≤/m¬≤.</p>

      <h3>‚öôÔ∏è 4. Aba PAR√ÇMETROS</h3>
      <ul>
        <li><strong>Valor hora laser (R$):</strong> energia, manuten√ß√£o e deprecia√ß√£o.</li>
        <li><strong>Valor hora m√£o de obra (R$):</strong> sal√°rio, pr√≥-labore e encargos.</li>
        <li><strong>Percentual de perdas (%):</strong> erros de corte, quebras, desperd√≠cio e retrabalho.</li>
        <li><strong>Overhead (%):</strong> aluguel, internet, marketing, administra√ß√£o e indiretos.</li>
      </ul>

      <h3>üßÆ 5. Aba SIMULADOR ‚Äì Campo por Campo</h3>
      <ul>
        <li><strong>Nome do Produto</strong> e <strong>SKU</strong> para identifica√ß√£o e controle.</li>
        <li><strong>Madeira selecionada</strong> para usar o custo correto da chapa.</li>
        <li><strong>Comprimento</strong> e <strong>Largura (cm)</strong> para c√°lculo de √°rea.</li>
        <li><strong>% da chapa (opcional):</strong> para formato irregular, m√∫ltiplas pe√ßas ou aproveitamento estrat√©gico. Se preenchido, substitui o c√°lculo autom√°tico por √°rea.</li>
        <li><strong>Tempo de Corte</strong>, <strong>Grava√ß√£o</strong> e <strong>Montagem</strong>.</li>
      </ul>

      <h3>üí∞ 6. Como o Sistema Calcula o Custo</h3>
      <ol>
        <li><strong>Custo da Madeira:</strong> por √°rea da pe√ßa ou % manual da chapa.</li>
        <li><strong>Custo do Laser:</strong> (corte + grava√ß√£o) √ó valor hora laser.</li>
        <li><strong>Custo de M√£o de Obra:</strong> montagem √ó valor hora m√£o de obra.</li>
        <li><strong>Ajuste de Perdas/Retrabalho:</strong> aplicado sobre madeira + laser + m√£o de obra.</li>
        <li><strong>Overhead:</strong> aplicado conforme configura√ß√£o da opera√ß√£o.</li>
        <li><strong>Custo Total Real:</strong> valor completo por unidade.</li>
      </ol>

      <h3>üíµ 7. Defini√ß√£o do Pre√ßo</h3>
      <p>Com o custo total calculado, voc√™ define a margem desejada. O sistema retorna pre√ßo ideal, lucro em R$ e margem l√≠quida real. Depois, desconta a taxa do canal de venda (Shopee, Instagram, loja f√≠sica etc.).</p>

      <h3>üìä 8. Entendendo os Resultados</h3>
      <ul>
        <li><strong>Custo Total:</strong> valor real de produ√ß√£o.</li>
        <li><strong>Pre√ßo Sugerido:</strong> pre√ßo para atingir a meta de margem.</li>
        <li><strong>Lucro:</strong> sobra ap√≥s custos e taxa do canal.</li>
        <li><strong>Margem L√≠quida:</strong> indicador real de rentabilidade.</li>
      </ul>

      <h3>üì¶ 9. Aba PRODUTOS</h3>
      <p>Hist√≥rico com nome, SKU, custo, pre√ßo, lucro, canal e margem. Permite compara√ß√£o, exporta√ß√£o e exclus√£o.</p>

      <h3>üìà 10. Estrat√©gia Recomendada</h3>
      <ul>
        <li>Margem m√≠nima recomendada: <strong>35%</strong>.</li>
        <li>Ideal para online: <strong>40% a 55%</strong>.</li>
        <li>Produtos personalizados: <strong>acima de 50%</strong>.</li>
        <li>Evite vender abaixo de <strong>30%</strong>.</li>
      </ul>

      <h3>üö® 11. Erros Comuns</h3>
      <ul>
        <li>N√£o considerar perdas.</li>
        <li>Esquecer o tempo de montagem.</li>
        <li>N√£o aplicar overhead.</li>
        <li>Copiar pre√ßo do concorrente sem c√°lculo.</li>
        <li>Ignorar taxas de marketplace.</li>
      </ul>

      <h3>üß† 12. Fluxo Ideal de Uso</h3>
      <ol>
        <li>Cadastrar madeiras.</li>
        <li>Ajustar par√¢metros.</li>
        <li>Calcular produto.</li>
        <li>Ajustar margem.</li>
        <li>Salvar e monitorar lucro.</li>
      </ol>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="tab-backup" class="hide">
    <div class="grid">
      <div class="card">
        <h2>Exportar</h2>
        <div class="muted">Gera um JSON com Madeiras + Par√¢metros + √∫ltimas entradas do Simulador.</div>
        <div class="btnbar">
          <button class="btn accent" id="btnExport">Baixar JSON</button>
          <button class="btn" id="btnReset">Resetar para padr√£o da planilha</button>
        </div>
      </div>

      <div class="card">
        <h2>Importar</h2>
        <div class="muted">Cole um JSON exportado aqui para restaurar.</div>
        <textarea id="importBox" rows="10" placeholder='Cole o JSON aqui'></textarea>
        <div class="btnbar">
          <button class="btn primary" id="btnImport">Importar JSON</button>
        </div>
      </div>
    </div>
  </section>
</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics.js";
  import {
    addDoc,
    collection,
    deleteDoc,
    doc,
    getDocs,
    getFirestore,
    orderBy,
    query,
    serverTimestamp,
    setDoc,
    updateDoc,
    writeBatch,
  } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
  // ====== DADOS INICIAIS (da planilha) ======
  const DEFAULT_DATA = {
    woods: [{"name": "MDF Cru 3mm", "thickness": 3, "width": 140, "height": 90, "price": 60, "obs": null}, {"name": "MDF Cru 6mm", "thickness": 6, "width": 140, "height": 90, "price": 130, "obs": null}, {"name": "MDF Branco 3mm", "thickness": 3, "width": 140, "height": 90, "price": 145, "obs": null}],
    params: {"custoHoraLaser": 30, "custoMaoObra": 18, "overhead": 1.5, "embalagem": 1.5, "perdasPct": 5, "taxas": {"Shopee": 20, "Mercado Livre": 16, "TikTok": 12}, "margemDesejada": 30},
    sim: {"wood": "MDF Cru 6mm", "comprimento": 80, "largura": 60, "areaCm2": 4800, "pctChapa": null, "tempoCorte": 10, "tempoGrav": 0, "tempoMont": 5, "canal": "Shopee", "margem": null, "nome": null, "sku": null},
    products: []
  };

  const LS_KEY = "precificacao_mdf_laser_v1";

  // ====== FIREBASE (Produtos no banco, sem login) ======
  const USE_FIREBASE_PRODUCTS = true;
  const firebaseConfig = {
    apiKey: "AIzaSyCgaed-Dlv0DhhL4Mnw74chOML3NeNIgJc",
    authDomain: "mm-decor-626f8.firebaseapp.com",
    projectId: "mm-decor-626f8",
    storageBucket: "mm-decor-626f8.firebasestorage.app",
    messagingSenderId: "437485954448",
    appId: "1:437485954448:web:60a1aa6d05dd09c0677f15",
    measurementId: "G-SK44ZGCS1E",
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const db = getFirestore(firebaseApp);
  try {
    getAnalytics(firebaseApp);
  } catch (e) {
    console.warn("Analytics indispon√≠vel neste ambiente:", e?.message || e);
  }


  function loadState() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return structuredClone(DEFAULT_DATA);
      const obj = JSON.parse(raw);
      // merge leve (para compatibilidade futura)
      return {
        woods: Array.isArray(obj.woods) ? obj.woods : structuredClone(DEFAULT_DATA.woods),
        params: obj.params ? obj.params : structuredClone(DEFAULT_DATA.params),
        sim: obj.sim ? obj.sim : structuredClone(DEFAULT_DATA.sim),
        products: Array.isArray(obj.products) ? obj.products : structuredClone(DEFAULT_DATA.products),
      };
    } catch(e) {
      console.warn("Falha ao ler localStorage:", e);
      return structuredClone(DEFAULT_DATA);
    }
  }

  function saveState() {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  let state = loadState();
  let lastCalc = null;

  // ====== UI: Tabs ======
  const tabButtons = document.querySelectorAll(".tab");
  tabButtons.forEach(btn => btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    document.querySelectorAll("section[id^='tab-']").forEach(s => s.classList.add("hide"));
    document.getElementById("tab-" + t).classList.remove("hide");
    if (t === "prod") loadCatalog();
  }));

  // ====== Helpers ======
  function n(v) {
    const x = Number(v);
    return Number.isFinite(x) ? x : null;
  }
  function fmtBRL(v) {
    if (v === null || v === "" || !Number.isFinite(v)) return "‚Äî";
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }
  function fmtPct(v) {
    if (v === null || v === "" || !Number.isFinite(v)) return "‚Äî";
    return (v*100).toLocaleString("pt-BR", { maximumFractionDigits: 2 }) + "%";
  }
  function fmtNum(v, dec = 2) {
    if (v === null || v === "" || !Number.isFinite(v)) return "‚Äî";
    return Number(v).toLocaleString("pt-BR", { minimumFractionDigits: dec, maximumFractionDigits: dec });
  }
  function clampNonNeg(x) {
    if (x === null) return null;
    return Math.max(0, x);
  }

  function woodComputed(w) {
    const width = n(w.width), height = n(w.height), price = n(w.price);
    const area = (width && height) ? (width * height)/10000 : null; // m¬≤
    const costm2 = (price && area) ? (price/area) : null;
    return {...w, area, costm2};
  }

  function getWoodByName(name) {
    return state.woods.find(w => w.name === name) || state.woods[0] || null;
  }

  // ====== SIMULADOR ======
  const el = {
    nome: document.getElementById("sim_nome"),
    sku: document.getElementById("sim_sku"),
    wood: document.getElementById("sim_wood"),
    comp: document.getElementById("sim_comp"),
    larg: document.getElementById("sim_larg"),
    pct: document.getElementById("sim_pct"),
    corte: document.getElementById("sim_corte"),
    grav: document.getElementById("sim_grav"),
    mont: document.getElementById("sim_mont"),
    canal: document.getElementById("sim_canal"),
    margem: document.getElementById("sim_margem"),
  };

  function fillSimSelect() {
    el.wood.innerHTML = "";
    state.woods.forEach(w => {
      const opt = document.createElement("option");
      opt.value = w.name;
      opt.textContent = w.name;
      el.wood.appendChild(opt);
    });
  }

  function loadSimInputsFromState() {
    fillSimSelect();
    el.nome.value = state.sim.nome ?? "";
    el.sku.value = state.sim.sku ?? "";
    el.wood.value = state.sim.wood || (state.woods[0]?.name ?? "");
    el.comp.value = state.sim.comprimento ?? "";
    el.larg.value = state.sim.largura ?? "";
    el.pct.value = state.sim.pctChapa ?? "";
    el.corte.value = state.sim.tempoCorte ?? "";
    el.grav.value = state.sim.tempoGrav ?? "";
    el.mont.value = state.sim.tempoMont ?? "";
    el.canal.value = state.sim.canal ?? "Shopee";
    el.margem.value = state.sim.margem ?? "";
  }

  function saveSimToState() {
    const prev = state.sim || {};
    const compVal = (el.comp.value === "" ? null : n(el.comp.value));
    const largVal = (el.larg.value === "" ? null : n(el.larg.value));
    const derivedArea = (compVal !== null && largVal !== null) ? (compVal * largVal) : null;

    state.sim = {
      nome: (el.nome?.value ?? "").trim() || null,
      sku: (el.sku?.value ?? "").trim() || null,
      wood: el.wood.value,
      comprimento: compVal,
      largura: largVal,
      // compatibilidade: mantemos areaCm2 para c√°lculos/backup.
      // - Se tiver comprimento e largura, areaCm2 = comprimento√ólargura
      // - Se ambos estiverem vazios, preserva o valor antigo (para n√£o "quebrar" quem j√° tinha salvo √°rea)
      // - Se s√≥ um deles for preenchido, areaCm2 fica null at√© completar os dois
      areaCm2: (derivedArea !== null) ? derivedArea : ((compVal === null && largVal === null) ? (n(prev.areaCm2) ?? null) : null),
      pctChapa: el.pct.value === "" ? null : n(el.pct.value),
      tempoCorte: el.corte.value === "" ? null : n(el.corte.value),
      tempoGrav: el.grav.value === "" ? null : n(el.grav.value),
      tempoMont: el.mont.value === "" ? null : n(el.mont.value),
      canal: el.canal.value,
      margem: el.margem.value === "" ? null : n(el.margem.value),
    };
    saveState();
  }


  function calcSim() {
    saveSimToState();
    const w0 = getWoodByName(state.sim.wood);
    const w = w0 ? woodComputed(w0) : null;

    // inputs
    const comp = clampNonNeg(n(state.sim.comprimento));
    const larg = clampNonNeg(n(state.sim.largura));
    // √Årea calculada a partir de comprimento√ólargura. Se n√£o tiver, usa areaCm2 antigo (compatibilidade).
    const areaCm2 = (comp !== null && comp !== 0 && larg !== null && larg !== 0)
      ? (comp * larg)
      : clampNonNeg(n(state.sim.areaCm2));
    const pctChapa = clampNonNeg(n(state.sim.pctChapa));
    const tCorte = clampNonNeg(n(state.sim.tempoCorte)) ?? 0;
    const tGrav  = clampNonNeg(n(state.sim.tempoGrav)) ?? 0;
    const tMont  = clampNonNeg(n(state.sim.tempoMont)) ?? 0;

    const canal = state.sim.canal || "Shopee";

    // params
    const p = state.params;
    const custoHoraLaser = n(p.custoHoraLaser) ?? 0;
    const custoMaoObra = n(p.custoMaoObra) ?? 0;
    const overhead = n(p.overhead) ?? 0;
    const embalagem = n(p.embalagem) ?? 0;
    const perdasPct = n(p.perdasPct) ?? 0;

    const taxaCanal = n(p.taxas?.[canal]) ?? 0;
    const margemUsada = (state.sim.margem === null || state.sim.margem === "" || !Number.isFinite(n(state.sim.margem)))
      ? (n(p.margemDesejada) ?? 0)
      : (n(state.sim.margem) ?? 0);

    // custo MDF da pe√ßa (replica planilha)
    let custoMdf = null;
    if (w) {
      if (pctChapa !== null && pctChapa !== 0) {
        const price = n(w.price);
        custoMdf = price !== null ? (price * (pctChapa/100)) : null;
      } else if (areaCm2 !== null && areaCm2 !== 0) {
        const costm2 = n(w.costm2);
        custoMdf = costm2 !== null ? (costm2 * (areaCm2/10000)) : null;
      } else {
        custoMdf = 0;
      }
    }

    const custoLaser = (custoHoraLaser/60) * (tCorte + tGrav);
    const custoMao = (custoMaoObra/60) * (tMont);
    const custoBase = (custoMdf ?? 0) + custoLaser + custoMao + overhead + embalagem;
    const ajustePerdas = custoBase * (perdasPct/100);
    const custoTotal = custoBase + ajustePerdas;

    const denom = 1 - (taxaCanal/100) - (margemUsada/100);
    const preco = (denom > 0) ? (custoTotal / denom) : null;

    const lucro = (preco !== null) ? (preco - custoTotal - (preco*(taxaCanal/100))) : null;
    const margemLiq = (preco !== null && preco !== 0 && lucro !== null) ? (lucro/preco) : null;

    // snapshot do c√°lculo atual (para salvar em Produtos)
    lastCalc = {
      ts: new Date().toISOString(),
      nome: state.sim.nome ?? null,
      sku: state.sim.sku ?? null,
      wood: w?.name ?? null,
      canal,
      taxaCanal,
      margemUsada,
      comp, larg, areaCm2, pctChapa,
      tCorte, tGrav, tMont,
      custoMdf: (custoMdf ?? 0),
      custoLaser,
      custoMao,
      overhead,
      embalagem,
      perdasPct,
      ajustePerdas,
      custoBase,
      custoTotal,
      preco,
      lucro,
      margemLiq,
    };

    // render
    const note = document.getElementById("noteWood");
    if (!w) {
      note.textContent = "Cadastre uma madeira para usar o simulador.";
    } else {
      const area = w.area ? w.area.toLocaleString("pt-BR", {maximumFractionDigits: 4}) : "‚Äî";
      const costm2 = w.costm2 ? fmtBRL(w.costm2) : "‚Äî";
      note.innerHTML = `<b>${w.name}</b> ‚Ä¢ ${w.thickness ?? "‚Äî"}mm ‚Ä¢ Chapa: ${w.width ?? "‚Äî"}√ó${w.height ?? "‚Äî"}cm ‚Ä¢ √Årea: ${area} m¬≤ ‚Ä¢ Custo/m¬≤: ${costm2}`;
    }

    document.getElementById("k_custo_total").textContent = fmtBRL(custoTotal);
    document.getElementById("k_preco").textContent = fmtBRL(preco);
    document.getElementById("k_lucro").textContent = fmtBRL(lucro);
    document.getElementById("k_margem_liq").textContent = (margemLiq === null) ? "‚Äî" : fmtPct(margemLiq);

    document.getElementById("d_mdf").textContent = fmtBRL(custoMdf ?? 0);
    document.getElementById("d_laser").textContent = fmtBRL(custoLaser);
    document.getElementById("d_mao").textContent = fmtBRL(custoMao);
    document.getElementById("d_over").textContent = fmtBRL(overhead);
    document.getElementById("d_emb").textContent = fmtBRL(embalagem);
    document.getElementById("d_base").textContent = fmtBRL(custoBase);
    document.getElementById("d_perdas").textContent = fmtBRL(ajustePerdas);
    document.getElementById("d_taxa").textContent = (taxaCanal/100).toLocaleString("pt-BR", {style:"percent", maximumFractionDigits:2});
    document.getElementById("d_margem_used").textContent = (margemUsada/100).toLocaleString("pt-BR", {style:"percent", maximumFractionDigits:2});
  }

  // auto recalcular em mudan√ßas
  Object.values(el).forEach(x => x.addEventListener("input", calcSim));
  el.wood.addEventListener("change", calcSim);
  el.canal.addEventListener("change", calcSim);

  document.getElementById("btnRecalcular").addEventListener("click", calcSim);
  document.getElementById("btnLimpar").addEventListener("click", () => {
    el.comp.value = "";
    el.larg.value = "";
    el.pct.value = "";
    el.margem.value = "";
    // garantir limpeza total (inclui compatibilidade de √°rea antiga)
    state.sim = {...(state.sim || {}), comprimento: null, largura: null, areaCm2: null};
    saveSimToState();
    calcSim();
  });

  // ====== MADEIRAS CRUD ======
  const woodsBody = document.querySelector("#woodsTable tbody");

  function renderWoods() {
    woodsBody.innerHTML = "";
    state.woods.forEach((w, idx) => {
      const wc = woodComputed(w);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input data-k="name" data-i="${idx}" value="${(w.name ?? "").replaceAll('"','&quot;')}" /></td>
        <td class="right"><input data-k="thickness" data-i="${idx}" type="number" step="0.01" value="${w.thickness ?? ""}" /></td>
        <td class="right"><input data-k="width" data-i="${idx}" type="number" step="0.01" value="${w.width ?? ""}" /></td>
        <td class="right"><input data-k="height" data-i="${idx}" type="number" step="0.01" value="${w.height ?? ""}" /></td>
        <td class="right"><input data-k="price" data-i="${idx}" type="number" step="0.01" value="${w.price ?? ""}" /></td>
        <td class="right">${wc.area ? wc.area.toLocaleString("pt-BR", {maximumFractionDigits:4}) : "‚Äî"}</td>
        <td class="right">${wc.costm2 ? fmtBRL(wc.costm2) : "‚Äî"}</td>
        <td><input data-k="obs" data-i="${idx}" value="${(w.obs ?? "").replaceAll('"','&quot;')}" /></td>
        <td class="right"><button class="btn danger" data-del="${idx}">Excluir</button></td>
      `;
      woodsBody.appendChild(tr);
    });

    // bind inputs
    woodsBody.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", () => {
        const i = Number(inp.dataset.i);
        const k = inp.dataset.k;
        if (!Number.isFinite(i)) return;
        const val = inp.value;
        // tipos num√©ricos
        if (["thickness","width","height","price"].includes(k)) {
          state.woods[i][k] = val === "" ? null : Number(val);
        } else {
          state.woods[i][k] = val === "" ? null : val;
        }
        saveState();
        fillSimSelect();
        fillProductWoodSelect();
        calcSim();
        renderWoods(); // re-render pra atualizar √°rea/custo
      });
    });

    // bind delete
    woodsBody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.dataset.del);
        state.woods.splice(i,1);
        if (state.woods.length === 0) {
          state.woods = structuredClone(DEFAULT_DATA.woods);
        }
        saveState();
        fillSimSelect();
        renderWoods();
        calcSim();
      });
    });
  }

  document.getElementById("btnAddWood").addEventListener("click", () => {
    state.woods.push({name:"Nova madeira", thickness:null, width:null, height:null, price:null, obs:null});
    saveState();
    renderWoods();
    fillSimSelect();
    fillProductWoodSelect();
  });



  // ====== PRODUTOS (Ficha t√©cnica + precifica√ß√£o) ======
  let productCatalog = [];
  let currentProductId = null;
  let currentSnapshot = null;

  const prodEls = {
    body: document.querySelector("#catalogTable tbody"),
    search: document.getElementById("prod_search"),
    status: document.getElementById("prod_filter_status"),
    categoria: document.getElementById("prod_filter_categoria"),
    esp: document.getElementById("prod_filter_esp"),
    canalFilter: document.getElementById("prod_filter_canal"),
    sort: document.getElementById("prod_sort"),
    refresh: document.getElementById("prod_refresh"),
    recalc: document.getElementById("prod_batch_recalc"),
    archiveSelected: document.getElementById("prod_archive_selected"),
    nome: document.getElementById("pf_nome"),
    sku: document.getElementById("pf_sku"),
    categoriaField: document.getElementById("pf_categoria"),
    tags: document.getElementById("pf_tags"),
    ativo: document.getElementById("pf_ativo"),
    wood: document.getElementById("pf_wood"),
    espField: document.getElementById("pf_esp"),
    qtdPecas: document.getElementById("pf_qtd_pecas"),
    comp: document.getElementById("pf_comp"),
    larg: document.getElementById("pf_larg"),
    pct: document.getElementById("pf_pct"),
    tc: document.getElementById("pf_tc"),
    tg: document.getElementById("pf_tg"),
    tm: document.getElementById("pf_tm"),
    tp: document.getElementById("pf_tp"),
    canal: document.getElementById("pf_canal"),
    margem: document.getElementById("pf_margem"),
    arquivo: document.getElementById("pf_arquivo"),
    arquivoData: document.getElementById("pf_arquivo_data"),
    obs: document.getElementById("pf_obs"),
    qualidade: document.getElementById("pf_qualidade"),
    insumos: document.getElementById("pf_insumos"),
    emb: document.getElementById("pf_emb"),
    embDim: document.getElementById("pf_emb_dim"),
    kCusto: document.getElementById("pf_k_custo"),
    kPreco: document.getElementById("pf_k_preco"),
    kLucro: document.getElementById("pf_k_lucro"),
    kMargem: document.getElementById("pf_k_margem"),
    history: document.getElementById("pf_history"),
  };

  function fillProductWoodSelect() {
    if (!prodEls.wood) return;
    prodEls.wood.innerHTML = "";
    state.woods.forEach(w => {
      const op = document.createElement("option");
      op.value = w.name;
      op.textContent = w.name;
      prodEls.wood.appendChild(op);
    });
  }

  function parseInsumos(raw) {
    return (raw || "").split("\n").map(l => l.trim()).filter(Boolean).map((line) => {
      const [nome, unidade, qtd, custo] = line.split("|").map(x => (x || "").trim());
      return { nome, unidade: unidade || "un", qtd: n(qtd) ?? 0, custoUnit: n(custo) ?? 0 };
    });
  }

  function parseEmbalagem(raw) {
    const [tipo, custo] = (raw || "").split("|").map(x => (x || "").trim());
    return { tipo: tipo || "caixa", custo: n(custo) ?? 0 };
  }

  function collectProductDraft() {
    const [arquivoNome, arquivoUrl, arquivoVersao] = (prodEls.arquivo.value || "").split("|").map(x => (x || "").trim());
    return {
      id: currentProductId,
      nome: (prodEls.nome.value || "").trim(),
      sku: (prodEls.sku.value || "").trim(),
      categoria: (prodEls.categoriaField.value || "").trim(),
      tags: (prodEls.tags.value || "").split(",").map(t => t.trim()).filter(Boolean),
      ativo: prodEls.ativo.value === "true",
      woodNome: prodEls.wood.value,
      woodId: state.woods.findIndex(w => w.name === prodEls.wood.value),
      espessura: n(prodEls.espField.value),
      quantidadePecas: n(prodEls.qtdPecas.value) ?? 1,
      dimensoes: { comp: n(prodEls.comp.value), larg: n(prodEls.larg.value), pctChapaOverride: n(prodEls.pct.value) },
      temposPadrao: { corteMin: n(prodEls.tc.value) ?? 0, gravacaoMin: n(prodEls.tg.value) ?? 0, montagemMin: n(prodEls.tm.value) ?? 0, pinturaMin: n(prodEls.tp.value) ?? 0 },
      canalPadrao: prodEls.canal.value,
      margemDesejada: n(prodEls.margem.value),
      arquivo: { nome: arquivoNome || null, url: arquivoUrl || null, versao: arquivoVersao || null, dataVersao: prodEls.arquivoData.value || null },
      observacoesTecnicas: prodEls.obs.value || "",
      qualidade: { checklist: ["corte ok","lixa ok","montagem ok","acabamento ok","embalagem ok"], pontosCriticos: prodEls.qualidade.value || "" },
      insumos: parseInsumos(prodEls.insumos.value),
      embalagem: { ...parseEmbalagem(prodEls.emb.value), dimensao: (prodEls.embDim.value || "").trim() || null },
    };
  }

  function calculateProductPricing(draft) {
    const w = woodComputed(getWoodByName(draft.woodNome) || {});
    const areaCm2 = (n(draft.dimensoes.comp) && n(draft.dimensoes.larg)) ? (n(draft.dimensoes.comp) * n(draft.dimensoes.larg)) : null;
    const pct = n(draft.dimensoes.pctChapaOverride);
    const custoMdf = (pct !== null && w.price) ? (w.price * (pct / 100)) : (areaCm2 && w.costm2 ? (areaCm2 / 10000) * w.costm2 : 0);
    const custoLaser = ((n(draft.temposPadrao.corteMin) ?? 0) + (n(draft.temposPadrao.gravacaoMin) ?? 0)) / 60 * (n(state.params.custoHoraLaser) ?? 0);
    const custoMao = ((n(draft.temposPadrao.montagemMin) ?? 0) + (n(draft.temposPadrao.pinturaMin) ?? 0)) / 60 * (n(state.params.custoMaoObra) ?? 0);
    const custoInsumos = (draft.insumos || []).reduce((acc, i) => acc + ((n(i.qtd) ?? 0) * (n(i.custoUnit) ?? 0)), 0);
    const custoEmbalagem = n(draft.embalagem?.custo) ?? (n(state.params.embalagem) ?? 0);
    const subtotal = custoMdf + custoLaser + custoMao + custoInsumos + custoEmbalagem;
    const perdasRate = (n(state.params.perdasPct) ?? 0) / 100;
    const overheadRate = (n(state.params.overheadPct) ?? n(state.params.overhead) ?? 0) / 100;
    const ajustePerdas = subtotal * perdasRate;
    const overheadValor = subtotal * overheadRate;
    const custoTotal = subtotal + ajustePerdas + overheadValor;
    const taxaUsada = (n(state.params.taxas?.[draft.canalPadrao]) ?? 0) / 100;
    const margemUsada = (n(draft.margemDesejada) ?? n(state.params.margemDesejada) ?? 0) / 100;
    const divisor = 1 - taxaUsada - margemUsada;
    const preco = divisor > 0 ? (custoTotal / divisor) : null;
    const lucro = preco ? (preco * (1 - taxaUsada) - custoTotal) : null;
    const margemLiq = (preco && lucro !== null) ? (lucro / preco) : null;
    return {
      custo_mdf: custoMdf,
      custo_laser: custoLaser,
      custo_mao_obra: custoMao,
      custo_insumos: custoInsumos,
      ajuste_perdas: ajustePerdas,
      overhead_valor: overheadValor,
      custo_total: custoTotal,
      preco_sugerido: preco,
      lucro,
      margem_liquida: margemLiq,
      data_calculo: new Date().toISOString(),
      canal_usado: draft.canalPadrao,
      taxa_usada: taxaUsada,
      margem_usada: margemUsada,
      areaCm2,
      pct,
      tempo_pintura_min: n(draft.temposPadrao.pinturaMin) ?? 0,
      quantidade_pecas: n(draft.quantidadePecas) ?? 1,
    };
  }

  function renderProductKPIs(snapshot) {
    prodEls.kCusto.textContent = fmtBRL(snapshot?.custo_total);
    prodEls.kPreco.textContent = fmtBRL(snapshot?.preco_sugerido);
    prodEls.kLucro.textContent = fmtBRL(snapshot?.lucro);
    prodEls.kMargem.textContent = fmtPct(snapshot?.margem_liquida);
  }

  async function fetchPricingHistory(productId) {
    if (!USE_FIREBASE_PRODUCTS || !db || !productId) return [];
    const snap = await getDocs(collection(db, "products", productId, "pricing_history"));
    return snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => String(b.data_calculo||"").localeCompare(String(a.data_calculo||"")));
  }

  function renderHistory(history) {
    if (!history?.length) {
      prodEls.history.textContent = "Sem revis√µes ainda.";
      return;
    }
    prodEls.history.innerHTML = history.slice(0, 5).map(h => `${new Date(h.data_calculo).toLocaleString("pt-BR")}: custo ${fmtBRL(h.custo_total)} ‚Üí pre√ßo ${fmtBRL(h.preco_sugerido)}`).join("<br>");
  }

  function renderCatalog() {
    if (!prodEls.body) return;
    const q = (prodEls.search.value || "").toLowerCase();
    const fStatus = prodEls.status.value;
    const fCat = (prodEls.categoria.value || "").toLowerCase();
    const fEsp = n(prodEls.esp.value);
    const fCanal = prodEls.canalFilter.value;
    let rows = productCatalog.filter(p => {
      const hit = [p.nome, p.sku, p.categoria, p.espessura, p.precificacaoAtual?.canal_usado].join(" ").toLowerCase().includes(q);
      const okStatus = fStatus === "all" || (fStatus === "active" ? !!p.ativo : !p.ativo);
      const okCat = !fCat || (p.categoria || "").toLowerCase().includes(fCat);
      const okEsp = fEsp === null || Number(p.espessura) === Number(fEsp);
      const okCanal = fCanal === "all" || (p.canalPadrao || p.precificacaoAtual?.canal_usado) === fCanal;
      return hit && okStatus && okCat && okEsp && okCanal;
    });
    if (prodEls.sort.value === "lucro") rows.sort((a,b)=>(b.precificacaoAtual?.lucro||0)-(a.precificacaoAtual?.lucro||0));
    else if (prodEls.sort.value === "margem") rows.sort((a,b)=>(b.precificacaoAtual?.margem_liquida||0)-(a.precificacaoAtual?.margem_liquida||0));
    else if (prodEls.sort.value === "mais_vendidos") rows.sort((a,b)=>(b.totalVendas||0)-(a.totalVendas||0));
    else rows.sort((a,b)=>String(b.updatedAt||"").localeCompare(String(a.updatedAt||"")));

    prodEls.body.innerHTML = "";
    if (!rows.length) {
      prodEls.body.innerHTML = '<tr><td colspan="11" class="muted">Nenhum produto encontrado.</td></tr>';
      return;
    }
    rows.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><input type="checkbox" data-select="${p.id}"></td><td>${p.nome || "‚Äî"}</td><td>${p.sku || "‚Äî"}</td><td>${p.woodNome || "‚Äî"} / ${p.espessura || "‚Äî"}mm</td><td>${p.canalPadrao || p.precificacaoAtual?.canal_usado || "‚Äî"}</td><td class="right">${fmtBRL(p.precificacaoAtual?.custo_total)}</td><td class="right">${fmtBRL(p.precificacaoAtual?.preco_sugerido)}</td><td class="right">${fmtBRL(p.precificacaoAtual?.lucro)}</td><td class="right">${fmtPct(p.precificacaoAtual?.margem_liquida)}</td><td>${p.ativo ? "ativo" : "inativo"}</td><td class="right"><button class="btn" data-open="${p.id}">Abrir</button> <button class="btn" data-dup="${p.id}">Duplicar</button> <button class="btn danger" data-arc="${p.id}">Arquivar</button></td>`;
      prodEls.body.appendChild(tr);
    });

    prodEls.body.querySelectorAll("button[data-open]").forEach(b => b.onclick = () => openProduct(b.dataset.open));
    prodEls.body.querySelectorAll("button[data-dup]").forEach(b => b.onclick = () => duplicateProduct(b.dataset.dup));
    prodEls.body.querySelectorAll("button[data-arc]").forEach(b => b.onclick = () => archiveProduct(b.dataset.arc));
  }

  async function loadCatalog() {
    if (!USE_FIREBASE_PRODUCTS || !db) return;
    const snap = await getDocs(collection(db, "products"));
    productCatalog = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderCatalog();
  }

  function fillProductForm(p = null) {
    currentProductId = p?.id || null;
    currentSnapshot = p?.precificacaoAtual || null;
    prodEls.nome.value = p?.nome || "";
    prodEls.sku.value = p?.sku || "";
    prodEls.categoriaField.value = p?.categoria || "";
    prodEls.tags.value = (p?.tags || []).join(", ");
    prodEls.ativo.value = String(p?.ativo ?? true);
    prodEls.wood.value = p?.woodNome || (state.woods[0]?.name || "");
    prodEls.espField.value = p?.espessura ?? "";
    prodEls.qtdPecas.value = p?.quantidadePecas ?? 1;
    prodEls.comp.value = p?.dimensoes?.comp ?? "";
    prodEls.larg.value = p?.dimensoes?.larg ?? "";
    prodEls.pct.value = p?.dimensoes?.pctChapaOverride ?? "";
    prodEls.tc.value = p?.temposPadrao?.corteMin ?? "";
    prodEls.tg.value = p?.temposPadrao?.gravacaoMin ?? "";
    prodEls.tm.value = p?.temposPadrao?.montagemMin ?? "";
    prodEls.tp.value = p?.temposPadrao?.pinturaMin ?? "";
    prodEls.canal.value = p?.canalPadrao || "Shopee";
    prodEls.margem.value = p?.margemDesejada ?? "";
    prodEls.arquivo.value = [p?.arquivo?.nome || "", p?.arquivo?.url || "", p?.arquivo?.versao || ""].join(" | ");
    prodEls.arquivoData.value = p?.arquivo?.dataVersao || "";
    prodEls.obs.value = p?.observacoesTecnicas || "";
    prodEls.qualidade.value = p?.qualidade?.pontosCriticos || "";
    prodEls.insumos.value = (p?.insumos || []).map(i => `${i.nome}|${i.unidade}|${i.qtd}|${i.custoUnit ?? 0}`).join("\n");
    prodEls.emb.value = `${p?.embalagem?.tipo || "caixa"}|${p?.embalagem?.custo ?? 0}`;
    prodEls.embDim.value = p?.embalagem?.dimensao || "";
    renderProductKPIs(currentSnapshot);
  }

  async function openProduct(id) {
    const product = productCatalog.find(p => p.id === id);
    if (!product) return;
    fillProductForm(product);
    const history = await fetchPricingHistory(id);
    renderHistory(history);
  }

  async function saveProduct() {
    const draft = collectProductDraft();
    if (!draft.nome || !draft.sku) return alert("Nome e SKU s√£o obrigat√≥rios.");
    const skuConflict = productCatalog.find(p => p.sku === draft.sku && p.id !== currentProductId);
    if (skuConflict) return alert("SKU j√° existe. Use um SKU √∫nico.");
    const existing = currentProductId ? productCatalog.find(p => p.id === currentProductId) : null;
    const previousSnapshot = existing?.precificacaoAtual || null;
    const snapshot = currentSnapshot || calculateProductPricing(draft);
    const payload = { ...draft, precificacaoAtual: snapshot, updatedAt: new Date().toISOString(), createdAt: draft.id ? (productCatalog.find(p => p.id === draft.id)?.createdAt || new Date().toISOString()) : new Date().toISOString() };

    if (USE_FIREBASE_PRODUCTS && db) {
      const ref = draft.id ? doc(db, "products", draft.id) : doc(collection(db, "products"));
      await setDoc(ref, payload, { merge: true });
      currentProductId = ref.id;
      if (!previousSnapshot || JSON.stringify(previousSnapshot) !== JSON.stringify(snapshot)) {
        await addDoc(collection(db, "products", ref.id, "pricing_history"), snapshot);
      }
    }
    await loadCatalog();
    alert("Produto salvo com sucesso.");
  }

  function calculateInForm() {
    const draft = collectProductDraft();
    currentSnapshot = calculateProductPricing(draft);
    renderProductKPIs(currentSnapshot);
  }

  async function archiveProduct(id = null) {
    const targetId = id || currentProductId;
    if (!targetId) return;
    if (USE_FIREBASE_PRODUCTS && db) {
      await updateDoc(doc(db, "products", targetId), { ativo: false, updatedAt: new Date().toISOString() });
    }
    await loadCatalog();
    if (!id) fillProductForm();
  }

  async function duplicateProduct(id = null) {
    const source = id ? productCatalog.find(p => p.id === id) : collectProductDraft();
    if (!source) return;
    const clone = structuredClone(source);
    delete clone.id;
    clone.nome = `${clone.nome || "Produto"} (c√≥pia)`;
    clone.sku = `${clone.sku || "SKU"}-COPIA-${Date.now().toString().slice(-4)}`;
    clone.createdAt = new Date().toISOString();
    clone.updatedAt = new Date().toISOString();
    if (USE_FIREBASE_PRODUCTS && db) {
      const ref = doc(collection(db, "products"));
      await setDoc(ref, clone);
      if (clone.precificacaoAtual) await addDoc(collection(db, "products", ref.id, "pricing_history"), clone.precificacaoAtual);
    }
    await loadCatalog();
  }

  async function batchRecalc() {
    for (const p of productCatalog) {
      const snapshot = calculateProductPricing(p);
      await updateDoc(doc(db, "products", p.id), { precificacaoAtual: snapshot, updatedAt: new Date().toISOString() });
      await addDoc(collection(db, "products", p.id, "pricing_history"), snapshot);
    }
    await loadCatalog();
    alert("Recalculo em lote conclu√≠do.");
  }

  async function archiveSelected() {
    const ids = Array.from(prodEls.body.querySelectorAll("input[data-select]:checked")).map(i => i.dataset.select);
    for (const id of ids) {
      await updateDoc(doc(db, "products", id), { ativo: false, updatedAt: new Date().toISOString() });
    }
    await loadCatalog();
  }

  [prodEls.search, prodEls.status, prodEls.categoria, prodEls.esp, prodEls.canalFilter, prodEls.sort].forEach(elm => elm?.addEventListener("input", renderCatalog));
  prodEls.refresh?.addEventListener("click", loadCatalog);
  prodEls.recalc?.addEventListener("click", batchRecalc);
  prodEls.archiveSelected?.addEventListener("click", archiveSelected);
  document.getElementById("pf_calcular").addEventListener("click", calculateInForm);
  document.getElementById("pf_salvar").addEventListener("click", saveProduct);
  document.getElementById("pf_duplicar").addEventListener("click", () => duplicateProduct());
  document.getElementById("pf_arquivar").addEventListener("click", () => archiveProduct());
  document.getElementById("pf_novo").addEventListener("click", () => fillProductForm());
  document.getElementById("btnSalvarProduto")?.addEventListener("click", async () => {
    if (!prodEls.nome.value) prodEls.nome.value = el.nome.value || "Produto do simulador";
    if (!prodEls.sku.value) prodEls.sku.value = el.sku.value || "";
    if (!prodEls.wood.value) prodEls.wood.value = el.wood.value || "";
    if (!prodEls.comp.value) prodEls.comp.value = el.comp.value || "";
    if (!prodEls.larg.value) prodEls.larg.value = el.larg.value || "";
    if (!prodEls.pct.value) prodEls.pct.value = el.pct.value || "";
    if (!prodEls.tc.value) prodEls.tc.value = el.corte.value || "";
    if (!prodEls.tg.value) prodEls.tg.value = el.grav.value || "";
    if (!prodEls.tm.value) prodEls.tm.value = el.mont.value || "";
    calculateInForm();
    await saveProduct();
  });

  // ====== PARAMETROS ======
  function loadParamsUI() {
    const p = state.params;
    document.getElementById("p_laser").value = p.custoHoraLaser ?? "";
    document.getElementById("p_mao").value = p.custoMaoObra ?? "";
    document.getElementById("p_over").value = p.overhead ?? "";
    document.getElementById("p_emb").value = p.embalagem ?? "";
    document.getElementById("p_perdas").value = p.perdasPct ?? "";
    document.getElementById("p_margem").value = p.margemDesejada ?? "";
    document.getElementById("p_tax_shopee").value = p.taxas?.["Shopee"] ?? "";
    document.getElementById("p_tax_ml").value = p.taxas?.["Mercado Livre"] ?? "";
    document.getElementById("p_tax_tt").value = p.taxas?.["TikTok"] ?? "";
  }

  function saveParamsFromUI() {
    const p = state.params;
    p.custoHoraLaser = n(document.getElementById("p_laser").value) ?? 0;
    p.custoMaoObra = n(document.getElementById("p_mao").value) ?? 0;
    p.overhead = n(document.getElementById("p_over").value) ?? 0;
    p.embalagem = n(document.getElementById("p_emb").value) ?? 0;
    p.perdasPct = n(document.getElementById("p_perdas").value) ?? 0;
    p.margemDesejada = n(document.getElementById("p_margem").value) ?? 0;
    p.taxas = {
      "Shopee": n(document.getElementById("p_tax_shopee").value) ?? 0,
      "Mercado Livre": n(document.getElementById("p_tax_ml").value) ?? 0,
      "TikTok": n(document.getElementById("p_tax_tt").value) ?? 0,
    };
    saveState();
    calcSim();
  }

  document.getElementById("btnSalvarParams").addEventListener("click", saveParamsFromUI);
  ["p_laser","p_mao","p_over","p_emb","p_perdas","p_margem","p_tax_shopee","p_tax_ml","p_tax_tt"].forEach(id => {
    document.getElementById(id).addEventListener("input", saveParamsFromUI);
  });

  // ====== BACKUP ======
  document.getElementById("btnExport").addEventListener("click", () => {
    const payload = JSON.stringify(state, null, 2);
    const blob = new Blob([payload], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "backup_precificacao_mdf_laser.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("btnImport").addEventListener("click", () => {
    try {
      const raw = document.getElementById("importBox").value.trim();
      if (!raw) return alert("Cole um JSON primeiro.");
      const obj = JSON.parse(raw);
      if (!obj.woods || !obj.params) return alert("JSON inv√°lido: faltam campos.");
      state = {
        woods: Array.isArray(obj.woods) ? obj.woods : structuredClone(DEFAULT_DATA.woods),
        params: obj.params || structuredClone(DEFAULT_DATA.params),
        sim: obj.sim || structuredClone(DEFAULT_DATA.sim),
        products: Array.isArray(obj.products) ? obj.products : structuredClone(DEFAULT_DATA.products),
      };
      saveState();
      // recarregar tudo
      loadSimInputsFromState();
      loadParamsUI();
      renderWoods();
      loadCatalog();
      calcSim();
      alert("Importado com sucesso!");
    } catch(e) {
      alert("Falha ao importar: " + e.message);
    }
  });

  document.getElementById("btnReset").addEventListener("click", () => {
    if (!confirm("Resetar tudo para o padr√£o da planilha?")) return;
    state = structuredClone(DEFAULT_DATA);
    saveState();
    loadSimInputsFromState();
    loadParamsUI();
    renderWoods();
    loadCatalog();
    calcSim();
  });

  // ====== INIT ======
  loadSimInputsFromState();
  loadParamsUI();
  renderWoods();
  fillProductWoodSelect();
  fillProductForm();
  loadCatalog();
  calcSim();
</script>
</body>
</html>
