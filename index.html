<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Precifica√ß√£o MDF + Laser</title>
  <style>
    :root {
      --bg:#f4eee8; --card:#fffdfb; --muted:#9c8978; --text:#5b4a3f;
      --accent:#a4ad8f; --accent2:#d2b39a; --danger:#cf9a9a; --border:#e5d8cc;
      --shadow:0 14px 30px rgba(152,126,104,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial; background:radial-gradient(circle at top,#f9f5f1,var(--bg) 70%); color:var(--text); padding:24px 12px 40px;}
    .app-shell{max-width:1220px; margin:0 auto; background:rgba(255,250,246,.85); border:1px solid #efe4db; border-radius:28px; box-shadow:var(--shadow); overflow:hidden; backdrop-filter:blur(6px);}
    header{padding:22px 28px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:12px; background:rgba(252,247,242,.92);}
    .brand{display:flex; align-items:center; gap:16px;}
    .logo-mark{width:58px; height:58px; border-radius:18px; background:linear-gradient(145deg,#ecd7c7,#f8efe8); color:#b99075; font-size:28px; display:grid; place-items:center; font-weight:700; box-shadow:inset 0 1px 0 #fff;}
    header h1{margin:0;font-size:37px;font-weight:500; letter-spacing:.3px; color:#8d705d;}
    header p{margin:2px 0 0; color:var(--muted); font-size:13px}
    .top-actions{display:flex; gap:10px; align-items:center;}
    .ghost-btn{border:1px solid var(--border); border-radius:14px; background:#fffcf9; padding:10px 14px; color:#8d705d; font-weight:600; box-shadow:0 2px 8px rgba(168,138,114,.1);}
    .profile{width:44px; height:44px; border-radius:50%; background:#b9c1aa; color:#fff; display:grid; place-items:center; font-weight:700;}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; padding:10px 20px; border-bottom:1px solid var(--border); background:#fffdfa;}
    .tab{border:1px solid transparent; background:transparent; color:#8f7a69; padding:11px 16px; border-radius:12px; cursor:pointer; font-weight:600; font-size:21px;}
    .tab.active{color:#6e8a63; background:#f6f1ec; border-color:#e8ddd2;}
    .wrap{padding:20px 18px 34px;}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start;}
    @media (max-width: 920px){ .grid{grid-template-columns: 1fr;} }
    .card{background:var(--card); border:1px solid var(--border); border-radius:20px; padding:16px; box-shadow:0 8px 20px rgba(162,132,106,.1);}
    .card h2{margin:0 0 10px; font-size:15px}
    .muted{color:var(--muted); font-size:12px; line-height:1.35}
    .row{display:grid; grid-template-columns: 1fr 200px; gap:10px; margin:10px 0; align-items:center;}
    @media (max-width: 520px){ .row{grid-template-columns:1fr;} }
    label{font-size:13px; font-weight:600}
    input, select, textarea{width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--border); background:#fffdfa; color:var(--text); outline:none;}
    input:focus, select:focus, textarea:focus{border-color:#d9beaa; box-shadow:0 0 0 3px rgba(223,197,176,.3);}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button.btn{padding:10px 14px; border-radius:12px; border:1px solid var(--border); cursor:pointer; font-weight:700; background:#f9f2ec; color:#7b6555;}
    button.btn.primary{background:#a8b196; color:#fff; border-color:#98a188;}
    button.btn.accent{background:#e9d5c4; border-color:#dfc2aa;}
    button.btn.danger{background:#f6e7e6; border-color:#eac6c6; color:#ad6d6d;}
    .kpis{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px;}
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr;} }
    .kpi{padding:12px; border-radius:16px; border:1px solid var(--border); background:#fff9f4;}
    .kpi .t{font-size:12px; color:var(--muted);}
    .kpi .v{font-size:20px; font-weight:800; margin-top:6px; letter-spacing:.2px}
    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; border:1px solid var(--border);}
    .table th,.table td{padding:10px; font-size:13px; border-bottom:1px solid var(--border);}
    .table th{text-align:left; color:var(--muted); background:#fcf7f2; font-weight:700}
    .table tr:last-child td{border-bottom:none}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted);}
    .pill.low{background:#fbe9e9; color:#a55b5b; border-color:#efcaca;}
    .pill.ok{background:#edf5ea; color:#5f7f56; border-color:#d5e5cf;}
    .right{text-align:right}
    .hide{display:none}
    .note{padding:10px 12px; border:1px dashed #decab8; border-radius:14px; background:#fff8f1; color:#8f7563; font-size:12px; line-height:1.4;}
    .footer{margin-top:16px; color:var(--muted); font-size:12px}
    a{color:#8f7a69}
    .summary-cards{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:12px;}
    @media (max-width: 980px){ .summary-cards{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 560px){ .summary-cards{grid-template-columns:1fr;} }

    .dashboard-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px;}
    @media (max-width: 900px){ .dashboard-grid{grid-template-columns:1fr;} }
    .dashboard-main-cards{display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-bottom:14px;}
    @media (max-width: 1180px){ .dashboard-main-cards{grid-template-columns:repeat(3,1fr);} }
    @media (max-width: 760px){ .dashboard-main-cards{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 500px){ .dashboard-main-cards{grid-template-columns:1fr;} }
    .dashboard-card{padding:14px; border-radius:18px; border:1px solid var(--border); background:linear-gradient(160deg,#fffdfb,#f8f2ed); box-shadow:0 6px 16px rgba(162,132,106,.08);}
    .dashboard-card .label{font-size:12px; color:var(--muted); display:flex; gap:6px; align-items:center;}
    .dashboard-card .value{font-size:26px; font-weight:800; margin-top:8px; color:#6b5a4d;}
    .dashboard-card .sub{font-size:12px; color:#96816f; margin-top:4px;}
    .kanban-mini{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; overflow:auto;}
    .kan-col{background:#fff9f4; border:1px solid var(--border); border-radius:14px; min-height:120px; padding:10px;}
    .kan-col h3{margin:0 0 8px; font-size:13px; color:#7c6656;}
    .kan-item{font-size:12px; background:#fff; border:1px solid #eadbcd; border-radius:10px; padding:7px; margin-bottom:6px;}
    .metric-line{display:flex; justify-content:space-between; gap:8px; font-size:13px; padding:8px 0; border-bottom:1px dashed #eadbcd;}
    .metric-line:last-child{border-bottom:none}
    .capacity-bar{height:10px; border-radius:999px; background:#efe4db; overflow:hidden; margin-top:8px;}
    .capacity-fill{height:100%; background:linear-gradient(90deg,#9eb395,#d2b39a);}
    .alert-list{display:grid; gap:8px;}
    .alert-item{padding:10px 12px; border-radius:12px; background:#fdf3f1; border:1px solid #f0d0cb; color:#a26b6b; font-size:13px;}
    .profit-list{display:grid; gap:8px;}
    .profit-item{display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border); border-radius:12px; padding:10px; background:#fffcf9;}
    .manual h2{font-size:22px; color:#7b6555; margin:0 0 8px;}
    .manual h3{font-size:17px; color:#8d705d; margin:16px 0 8px;}
    .manual p,.manual li{font-size:14px; line-height:1.5; color:#6f5b4f;}
    .manual ul,.manual ol{margin:8px 0 0 20px; padding:0;}
    .manual .checklist{display:grid; gap:8px; margin-top:10px;}
    .manual .check{background:#f9f2ec; border:1px solid var(--border); border-radius:12px; padding:8px 10px; font-weight:600; color:#7b6555;}

    .status-pill{display:inline-flex; align-items:center; gap:4px; padding:4px 9px; border-radius:999px; font-size:12px; font-weight:600; border:1px solid transparent;}
    .orders-layout{display:grid; grid-template-columns:1.1fr .9fr; gap:14px; align-items:start;}
    @media (max-width: 980px){ .orders-layout{grid-template-columns:1fr;} }
    .order-item-grid{display:grid; grid-template-columns:1.6fr .7fr .8fr .9fr auto; gap:8px; margin-top:8px;}
    @media (max-width: 760px){ .order-item-grid{grid-template-columns:1fr 1fr;} .order-item-grid .btn{grid-column:span 2;} }
    .order-item-row{display:contents;}
    .alert-delay{padding:10px; border-radius:12px; border:1px solid #f0c5b8; background:#fdf1ed; color:#a06052; font-size:12px; margin-top:8px;}

    @media (max-width: 880px){
      header{flex-direction:column; align-items:flex-start;}
      header h1{font-size:28px;}
      .top-actions{width:100%;}
      .ghost-btn{flex:1;}
      .tab{font-size:18px;}
    }
  </style>
</head>
<body>
<div class="app-shell">
<header>
  <div class="brand">
    <div class="logo-mark">M</div>
    <div>
      <h1>Sistema de Precifica√ß√£o MM Decor</h1>
      <p>Visual suave e organizado para uso di√°rio no simulador, par√¢metros e produtos.</p>
    </div>
  </div>
  <div class="top-actions">
    <button class="ghost-btn" type="button">Exportar CSV</button>
    <button class="ghost-btn" type="button">Conta</button>
    <div class="profile">M</div>
  </div>
</header>

<div class="tabs">
  <button class="tab active" data-tab="dashboard">Dashboard</button>
  <button class="tab" data-tab="sim">Simulador</button>
  <button class="tab" data-tab="madeiras">Madeiras</button>
  <button class="tab" data-tab="param">Par√¢metros</button>
  <button class="tab" data-tab="prod">Produtos</button>
  <button class="tab" data-tab="pedidos">Pedidos</button>
  <button class="tab" data-tab="financeiro">Financeiro</button>
  <button class="tab" data-tab="estoque">Estoque</button>
  <button class="tab" data-tab="manual">Manual</button>
  <button class="tab" data-tab="backup">Backup</button>
</div>

<div class="wrap">

  <!-- DASHBOARD -->
  <section id="tab-dashboard">
    <div class="card">
      <h2>Dashboard ¬∑ Painel Geral da F√°brica</h2>
      <div class="muted">Vis√£o r√°pida para responder: estou vendendo, lucrando, atrasado e com estoque suficiente?</div>
      <div class="dashboard-main-cards" id="dashMainCards"></div>
      <div class="dashboard-grid">
        <div class="card">
          <h2>Status dos Pedidos</h2>
          <div class="kanban-mini" id="dashKanban"></div>
        </div>
        <div class="card">
          <h2>Produ√ß√£o do Dia</h2>
          <div id="dashProducao"></div>
        </div>
        <div class="card">
          <h2>Estoque Cr√≠tico</h2>
          <div class="alert-list" id="dashEstoqueCritico"></div>
        </div>
        <div class="card">
          <h2>Produtos Mais Lucrativos</h2>
          <div class="profit-list" id="dashTopProdutos"></div>
        </div>
      </div>
    </div>
  </section>


  <!-- SIMULADOR -->
  <section id="tab-sim" class="hide">
    <div class="grid">
      <div class="card">
        <h2>Simulador (1 produto)</h2>
        <div class="muted">Preencha os campos. Use <b>Comprimento √ó Largura</b> OU <b>% da chapa</b>. Se preencher os dois, o sistema usa <b>% da chapa</b>.</div>

        <div class="row">
          <label>Nome do produto</label>
          <input id="sim_nome" type="text" placeholder="Ex.: Display Alga 60cm" />
        </div>

        <div class="row">
          <label>SKU</label>
          <input id="sim_sku" type="text" placeholder="Ex.: ALG-60-6MM" />
        </div>

        <div class="row">
          <label>Madeira selecionada</label>
          <select id="sim_wood"></select>
        </div>

        <div class="row">
          <label>Comprimento da pe√ßa (cm)</label>
          <input id="sim_comp" type="number" step="0.01" placeholder="Ex.: 20" />
        </div>

        <div class="row">
          <label>Largura da pe√ßa (cm)</label>
          <input id="sim_larg" type="number" step="0.01" placeholder="Ex.: 15" />
        </div>

        <div class="row">
          <label>% da chapa (opcional)</label>
          <input id="sim_pct" type="number" step="0.01" placeholder="Ex.: 12,5" />
        </div>

        <div class="row">
          <label>Tempo de corte (min)</label>
          <input id="sim_corte" type="number" step="0.01" />
        </div>

        <div class="row">
          <label>Tempo de grava√ß√£o (min) (opcional)</label>
          <input id="sim_grav" type="number" step="0.01" />
        </div>

        <div class="row">
          <label>Tempo de montagem/acabamento (min)</label>
          <input id="sim_mont" type="number" step="0.01" />
        </div>

        <div class="row">
          <label>Canal</label>
          <select id="sim_canal">
            <option>Shopee</option>
            <option>Mercado Livre</option>
            <option>TikTok</option>
          </select>
        </div>

        <div class="row">
          <label>Margem desejada (%) (opcional)</label>
          <input id="sim_margem" type="number" step="0.01" placeholder="Se vazio, usa a margem padr√£o em Par√¢metros" />
        </div>

        <div class="btnbar">
          <button class="btn accent" id="btnRecalcular">Recalcular</button>
          <button class="btn primary" id="btnSalvarProduto">Salvar produto</button>
          <button class="btn" id="btnLimpar">Limpar campos</button>
        </div>

        <div class="footer">Dica: edite Madeiras/Par√¢metros para refletir sua opera√ß√£o. O c√°lculo replica a l√≥gica da planilha.</div>
      </div>

      <div class="card">
        <h2>Resultado</h2>
        <div class="note" id="noteWood">‚Äî</div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Custo total (R$)</div>
            <div class="v" id="k_custo_total">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Pre√ßo sugerido (R$)</div>
            <div class="v" id="k_preco">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Lucro l√≠quido estimado (R$)</div>
            <div class="v" id="k_lucro">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Margem l√≠quida estimada</div>
            <div class="v" id="k_margem_liq">‚Äî</div>
          </div>
        </div>

        <h2 style="margin-top:14px;">Detalhamento</h2>
        <table class="table">
          <tbody>
            <tr><td>Custo MDF da pe√ßa</td><td class="right" id="d_mdf">‚Äî</td></tr>
            <tr><td>Custo laser</td><td class="right" id="d_laser">‚Äî</td></tr>
            <tr><td>Custo m√£o de obra</td><td class="right" id="d_mao">‚Äî</td></tr>
            <tr><td>Overhead</td><td class="right" id="d_over">‚Äî</td></tr>
            <tr><td>Embalagem</td><td class="right" id="d_emb">‚Äî</td></tr>
            <tr><td><b>Custo base</b></td><td class="right" id="d_base">‚Äî</td></tr>
            <tr><td>Ajuste perdas/retrabalho</td><td class="right" id="d_perdas">‚Äî</td></tr>
            <tr><td><b>Taxa do canal</b></td><td class="right" id="d_taxa">‚Äî</td></tr>
            <tr><td><b>Margem usada</b></td><td class="right" id="d_margem_used">‚Äî</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- MADEIRAS -->
  <section id="tab-madeiras" class="hide">
    <div class="card">
      <h2>Cadastro de Madeiras</h2>
      <div class="muted">Voc√™ pode adicionar/editar/remover materiais. Isso impacta o Simulador.</div>

      <div class="btnbar">
        <button class="btn primary" id="btnAddWood">Adicionar madeira</button>
        <span class="pill">Tudo salva automaticamente</span>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table class="table" id="woodsTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th class="right">Esp. (mm)</th>
              <th class="right">Larg. (cm)</th>
              <th class="right">Alt. (cm)</th>
              <th class="right">Pre√ßo chapa (R$)</th>
              <th class="right">√Årea chapa (m¬≤)</th>
              <th class="right">Custo (R$/m¬≤)</th>
              <th>Obs.</th>
              <th class="right">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer">C√°lculos autom√°ticos: √Årea (m¬≤) = (largura√óaltura)/10000; Custo/m¬≤ = pre√ßo/√°rea.</div>
    </div>
  </section>

  <!-- PARAMETROS -->
  <section id="tab-param" class="hide">
    <div class="grid">
      <div class="card">
        <h2>Par√¢metros Gerais</h2>

        <div class="row"><label>Custo hora laser (R$/h)</label><input id="p_laser" type="number" step="0.01" /></div>
        <div class="row"><label>Custo m√£o de obra (R$/h)</label><input id="p_mao" type="number" step="0.01" /></div>
        <div class="row"><label>Overhead por pe√ßa (R$)</label><input id="p_over" type="number" step="0.01" /></div>
        <div class="row"><label>Embalagem por pe√ßa (R$)</label><input id="p_emb" type="number" step="0.01" /></div>
        <div class="row"><label>Retrabalho/perdas (%)</label><input id="p_perdas" type="number" step="0.01" /></div>
        <div class="row"><label>Margem padr√£o (l√≠quida) (%)</label><input id="p_margem" type="number" step="0.01" /></div>

        <div class="btnbar">
          <button class="btn accent" id="btnSalvarParams">Salvar par√¢metros</button>
        </div>

        <div class="footer">A margem padr√£o s√≥ √© usada quando a Margem do Simulador estiver vazia.</div>
      </div>

      <div class="card">
        <h2>Canais & Taxas</h2>
        <div class="row"><label>Shopee - Taxa (%)</label><input id="p_tax_shopee" type="number" step="0.01" /></div>
        <div class="row"><label>Mercado Livre - Taxa (%)</label><input id="p_tax_ml" type="number" step="0.01" /></div>
        <div class="row"><label>TikTok - Taxa (%)</label><input id="p_tax_tt" type="number" step="0.01" /></div>

        <div class="note">Dica: se o seu canal tiver taxa fixa + vari√°vel, voc√™ pode embutir a taxa fixa no Overhead/Embalagem e deixar aqui s√≥ a parte percentual.</div>
      </div>
    </div>
  </section>


  <!-- PRODUTOS -->
  <section id="tab-prod" class="hide">
    <div class="grid">
      <div class="card">
        <h2>M√≥dulo Produtos</h2>
        <div class="muted">Cadastro com ficha t√©cnica, precifica√ß√£o autom√°tica e hist√≥rico de rec√°lculo.</div>
        <div class="btnbar">
          <button class="btn primary" id="btnNovoProduto">Novo produto</button>
        </div>
        <div style="margin-top:12px; overflow:auto;">
          <table class="table" id="prodTable">
            <thead>
              <tr>
                <th>Nome</th>
                <th>SKU</th>
                <th class="right">Custo total</th>
                <th class="right">Pre√ßo sugerido</th>
                <th class="right">Lucro</th>
                <th class="right">Margem %</th>
                <th>Status</th>
                <th class="right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Criar / Editar Produto</h2>
        <div class="row"><label>Nome do produto*</label><input id="prod_nome" type="text" /></div>
        <div class="row"><label>SKU √∫nico*</label><input id="prod_sku" type="text" /></div>
        <div class="row"><label>Categoria*</label><input id="prod_categoria" type="text" placeholder="Festa, Brinquedo..." /></div>
        <div class="row"><label>Madeira*</label><select id="prod_wood"></select></div>
        <div class="row"><label>Espessura</label><input id="prod_espessura" type="text" placeholder="Ex.: 6mm" /></div>
        <div class="row"><label>Status</label><select id="prod_ativo"><option value="true">Ativo</option><option value="false">Inativo</option></select></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0;" />
        <div class="row"><label>Comprimento (cm)</label><input id="prod_comp" type="number" step="0.01" /></div>
        <div class="row"><label>Largura (cm)</label><input id="prod_larg" type="number" step="0.01" /></div>
        <div class="row"><label>% da chapa (opcional)</label><input id="prod_pct" type="number" step="0.01" /></div>
        <div class="row"><label>Tempo corte (min)</label><input id="prod_corte" type="number" step="0.01" /></div>
        <div class="row"><label>Tempo grava√ß√£o (min)</label><input id="prod_gravacao" type="number" step="0.01" /></div>
        <div class="row"><label>Tempo montagem (min)</label><input id="prod_montagem" type="number" step="0.01" /></div>
        <div class="row"><label>Custo embalagem (R$)</label><input id="prod_embalagem" type="number" step="0.01" /></div>
        <div class="row"><label>Canal para snapshot</label><select id="prod_canal"><option>Shopee</option><option>Mercado Livre</option><option>TikTok</option></select></div>
        <div class="row"><label>Margem desejada (%)</label><input id="prod_margem" type="number" step="0.01" /></div>
        <div class="row" style="grid-template-columns:1fr;"><label>Observa√ß√µes t√©cnicas</label><textarea id="prod_obs" rows="2"></textarea></div>
        <div class="btnbar">
          <button class="btn accent" id="btnRecalcularProduto">Recalcular</button>
          <button class="btn primary" id="btnSalvarProdutoModulo">Salvar produto</button>
        </div>
        <div class="note" id="prodResumoCalc">Preencha os dados e clique em recalcular.</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Hist√≥rico de Precifica√ß√£o</h2>
      <div style="overflow:auto;">
        <table class="table" id="histTable">
          <thead><tr><th>Data</th><th>Produto/SKU</th><th class="right">Custo total</th><th class="right">Pre√ßo</th><th class="right">Margem</th><th>Canal</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PEDIDOS -->
  <section id="tab-pedidos" class="hide">
    <div class="card" style="margin-bottom:14px;">
      <h2>Lista de Pedidos</h2>
      <div class="muted">Fluxo completo: cliente, prazos, status de produ√ß√£o e lucro por pedido.</div>
      <div class="btnbar"><button class="btn primary" id="btnNovoPedido">Novo pedido</button></div>
      <div style="overflow:auto; margin-top:12px;">
        <table class="table" id="ordersTable">
          <thead><tr><th>N¬∫ Pedido</th><th>Cliente</th><th>Canal</th><th>Data pedido</th><th>Prazo</th><th class="right">Valor</th><th class="right">Lucro</th><th>Status</th><th class="right">A√ß√µes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="orders-layout">
      <div class="card">
        <h2>Criar / Editar Pedido</h2>
        <h3 style="margin:6px 0; font-size:14px;">A) Dados do Cliente</h3>
        <div class="row"><label>Nome</label><input id="order_clienteNome" type="text" /></div>
        <div class="row"><label>Telefone</label><input id="order_telefone" type="text" /></div>
        <div class="row"><label>Canal</label><select id="order_canal"><option>Shopee</option><option>Instagram</option><option>Mercado Livre</option><option>TikTok</option><option>Loja F√≠sica</option></select></div>
        <div class="row" style="grid-template-columns:1fr;"><label>Observa√ß√µes</label><textarea id="order_obs" rows="2"></textarea></div>

        <h3 style="margin:12px 0 6px; font-size:14px;">B) Itens do Pedido</h3>
        <div class="order-item-grid" id="orderItemsGrid"></div>
        <div class="btnbar"><button class="btn" id="btnAddOrderItem">+ Adicionar item</button></div>

        <h3 style="margin:12px 0 6px; font-size:14px;">C) Prazos</h3>
        <div class="row"><label>Data do pedido</label><input id="order_dataPedido" type="date" /></div>
        <div class="row"><label>Data prometida</label><input id="order_dataEntrega" type="date" /></div>
        <div id="orderDelayAlert" class="alert-delay hide"></div>

        <h3 style="margin:12px 0 6px; font-size:14px;">D) Status do Pedido</h3>
        <div class="row"><label>Status</label><select id="order_status"></select></div>
        <div class="btnbar"><button class="btn accent" id="btnSalvarPedido">Salvar pedido</button></div>
      </div>

      <div class="card">
        <h2>Resumo Financeiro do Pedido</h2>
        <div class="kpis">
          <div class="kpi"><div class="t">Receita total</div><div class="v" id="orderResumoReceita">R$ 0,00</div></div>
          <div class="kpi"><div class="t">Custo total</div><div class="v" id="orderResumoCusto">R$ 0,00</div></div>
          <div class="kpi"><div class="t">Lucro total</div><div class="v" id="orderResumoLucro">R$ 0,00</div></div>
          <div class="kpi"><div class="t">Margem %</div><div class="v" id="orderResumoMargem">0%</div></div>
        </div>
        <div class="note" id="orderResumoProducao">Sem OP gerada.</div>
      </div>
    </div>
  </section>

  <!-- FINANCEIRO -->
  <section id="tab-financeiro" class="hide">
    <div class="summary-cards">
      <div class="kpi"><div class="t">Entrada real recebida (m√™s)</div><div class="v" id="finEntradaRecebida">R$ 0,00</div></div>
      <div class="kpi"><div class="t">Pagamento pendente</div><div class="v" id="finPagamentoPendente">R$ 0,00</div></div>
      <div class="kpi"><div class="t">Custos fixos mensais</div><div class="v" id="finCustosFixos">R$ 0,00</div></div>
      <div class="kpi"><div class="t">Fluxo de caixa do m√™s</div><div class="v" id="finFluxoCaixa">R$ 0,00</div></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Custos Fixos Mensais</h2>
        <div class="muted">Cadastre aluguel, internet, energia, contador, pr√≥-labore e outros custos recorrentes.</div>
        <div class="row"><label>Descri√ß√£o</label><input id="finFixedDesc" type="text" placeholder="Ex.: Aluguel" /></div>
        <div class="row"><label>Valor mensal (R$)</label><input id="finFixedValue" type="number" step="0.01" /></div>
        <div class="btnbar"><button class="btn primary" id="btnAddFixedCost">Adicionar custo fixo</button></div>
        <div style="margin-top:12px; overflow:auto;">
          <table class="table" id="finFixedTable">
            <thead><tr><th>Descri√ß√£o</th><th class="right">Valor</th><th class="right">A√ß√µes</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Lan√ßamentos Financeiros</h2>
        <div class="muted">Registre entradas e sa√≠das reais para medir lucro real e fluxo de caixa.</div>
        <div class="row"><label>Tipo</label><select id="finType"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select></div>
        <div class="row"><label>Descri√ß√£o</label><input id="finDesc" type="text" placeholder="Ex.: Pedido #2048" /></div>
        <div class="row"><label>Valor (R$)</label><input id="finValue" type="number" step="0.01" /></div>
        <div class="row"><label>Data</label><input id="finDate" type="date" /></div>
        <div class="row"><label>Status</label><select id="finStatus"><option value="recebido">Recebido / Pago</option><option value="pendente">Pendente</option></select></div>
        <div class="btnbar"><button class="btn accent" id="btnAddFinanceEntry">Adicionar lan√ßamento</button></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Resultado Real do M√™s</h2>
      <div class="kpis">
        <div class="kpi"><div class="t">Lucro estimado (pedidos)</div><div class="v" id="finLucroEstimado">R$ 0,00</div></div>
        <div class="kpi"><div class="t">Lucro real do m√™s</div><div class="v" id="finLucroReal">R$ 0,00</div></div>
      </div>
      <div class="note" id="finResumo">Sem dados financeiros lan√ßados neste m√™s.</div>
      <div style="margin-top:12px; overflow:auto;">
        <table class="table" id="finEntriesTable">
          <thead><tr><th>Data</th><th>Tipo</th><th>Status</th><th>Descri√ß√£o</th><th class="right">Valor</th><th class="right">A√ß√µes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ESTOQUE -->
  <section id="tab-estoque" class="hide">
    <div class="summary-cards">
      <div class="kpi">
        <div class="t">Total chapas MDF em estoque</div>
        <div class="v" id="invTotalMdf">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">Total embalagens dispon√≠veis</div>
        <div class="v" id="invTotalEmb">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">Alertas de estoque baixo</div>
        <div class="v" id="invAlerts">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">√öltima atualiza√ß√£o</div>
        <div class="v" id="invUpdated" style="font-size:16px;">‚Äî</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Lista de Materiais</h2>
        <div class="muted">Controle simples de MDF e embalagens com status autom√°tico de estoque m√≠nimo.</div>
        <div class="btnbar">
          <button class="btn primary" id="btnAddInventoryItem">Adicionar material</button>
        </div>
        <div style="margin-top:12px; overflow:auto;">
          <table class="table" id="invItemsTable">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipo</th>
                <th class="right">Esp. (mm)</th>
                <th class="right">Dimens√£o</th>
                <th class="right">Qtd atual</th>
                <th class="right">Estoque m√≠n.</th>
                <th class="right">Valor un.</th>
                <th class="right">Custo m√©dio</th>
                <th>Status</th>
                <th class="right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Movimenta√ß√£o de Estoque</h2>
        <div class="row"><label>Tipo</label><select id="invMovType"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select></div>
        <div class="row"><label>Material</label><select id="invMovItem"></select></div>
        <div class="row"><label>Quantidade</label><input id="invMovQty" type="number" step="0.01" /></div>
        <div class="row"><label>Motivo</label><select id="invMovReason"><option>Compra</option><option>Produ√ß√£o</option><option>Ajuste manual</option><option>Perda</option></select></div>
        <div class="row" style="grid-template-columns:1fr;"><label>Observa√ß√£o</label><textarea id="invMovObs" rows="2" placeholder="Opcional"></textarea></div>
        <div class="btnbar">
          <button class="btn primary" id="btnAddInventoryMovement">Adicionar Entrada/Sa√≠da</button>
        </div>
        <div class="note">Sa√≠da autom√°tica por OP: use o bot√£o <b>Gerar OP</b> na aba Produtos para debitar MDF proporcional (% da chapa) e embalagem automaticamente.</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Hist√≥rico de Movimenta√ß√µes</h2>
      <div style="overflow:auto;">
        <table class="table" id="invMovTable">
          <thead><tr><th>Data</th><th>Tipo</th><th>Material</th><th class="right">Qtd</th><th>Motivo</th><th>Observa√ß√£o</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="tab-manual" class="hide">
    <div class="card manual">
      <h2>üìò MANUAL COMPLETO</h2>
      <p><strong>Sistema de Precifica√ß√£o MM Decor</strong><br />Precifica√ß√£o Profissional MDF + Laser.</p>

      <div class="checklist">
        <div class="check">‚úÖ Custo de m√£o de obra</div>
        <div class="check">‚úÖ Ajuste de perdas / retrabalho</div>
        <div class="check">‚úÖ Overhead</div>
        <div class="check">‚úÖ % da chapa (opcional)</div>
      </div>

      <h3>üéØ 1. Objetivo do Sistema</h3>
      <p>O sistema calcula custo real de produ√ß√£o, custo completo (direto + indireto), pre√ßo ideal de venda, lucro real por unidade e margem l√≠quida ap√≥s taxas. Ele evita venda abaixo do custo real.</p>

      <h3>üß≠ 2. Estrutura do Sistema</h3>
      <p>O sistema possui 4 √°reas principais: <strong>Simulador</strong>, <strong>Madeiras</strong>, <strong>Par√¢metros</strong> e <strong>Produtos</strong>.</p>

      <h3>ü™µ 3. Aba MADEIRAS</h3>
      <ul>
        <li><strong>Nome da Madeira:</strong> identifica√ß√£o do material (ex.: MDF 6mm Cru).</li>
        <li><strong>Largura da Chapa (cm):</strong> medida horizontal da chapa inteira.</li>
        <li><strong>Altura da Chapa (cm):</strong> medida vertical da chapa inteira.</li>
        <li><strong>Valor da Chapa (R$):</strong> valor total pago pela chapa.</li>
      </ul>
      <p>O sistema calcula automaticamente √°rea total da chapa e custo por cm¬≤/m¬≤.</p>

      <h3>‚öôÔ∏è 4. Aba PAR√ÇMETROS</h3>
      <ul>
        <li><strong>Valor hora laser (R$):</strong> energia, manuten√ß√£o e deprecia√ß√£o.</li>
        <li><strong>Valor hora m√£o de obra (R$):</strong> sal√°rio, pr√≥-labore e encargos.</li>
        <li><strong>Percentual de perdas (%):</strong> erros de corte, quebras, desperd√≠cio e retrabalho.</li>
        <li><strong>Overhead (%):</strong> aluguel, internet, marketing, administra√ß√£o e indiretos.</li>
      </ul>

      <h3>üßÆ 5. Aba SIMULADOR ‚Äì Campo por Campo</h3>
      <ul>
        <li><strong>Nome do Produto</strong> e <strong>SKU</strong> para identifica√ß√£o e controle.</li>
        <li><strong>Madeira selecionada</strong> para usar o custo correto da chapa.</li>
        <li><strong>Comprimento</strong> e <strong>Largura (cm)</strong> para c√°lculo de √°rea.</li>
        <li><strong>% da chapa (opcional):</strong> para formato irregular, m√∫ltiplas pe√ßas ou aproveitamento estrat√©gico. Se preenchido, substitui o c√°lculo autom√°tico por √°rea.</li>
        <li><strong>Tempo de Corte</strong>, <strong>Grava√ß√£o</strong> e <strong>Montagem</strong>.</li>
      </ul>

      <h3>üí∞ 6. Como o Sistema Calcula o Custo</h3>
      <ol>
        <li><strong>Custo da Madeira:</strong> por √°rea da pe√ßa ou % manual da chapa.</li>
        <li><strong>Custo do Laser:</strong> (corte + grava√ß√£o) √ó valor hora laser.</li>
        <li><strong>Custo de M√£o de Obra:</strong> montagem √ó valor hora m√£o de obra.</li>
        <li><strong>Ajuste de Perdas/Retrabalho:</strong> aplicado sobre madeira + laser + m√£o de obra.</li>
        <li><strong>Overhead:</strong> aplicado conforme configura√ß√£o da opera√ß√£o.</li>
        <li><strong>Custo Total Real:</strong> valor completo por unidade.</li>
      </ol>

      <h3>üíµ 7. Defini√ß√£o do Pre√ßo</h3>
      <p>Com o custo total calculado, voc√™ define a margem desejada. O sistema retorna pre√ßo ideal, lucro em R$ e margem l√≠quida real. Depois, desconta a taxa do canal de venda (Shopee, Instagram, loja f√≠sica etc.).</p>

      <h3>üìä 8. Entendendo os Resultados</h3>
      <ul>
        <li><strong>Custo Total:</strong> valor real de produ√ß√£o.</li>
        <li><strong>Pre√ßo Sugerido:</strong> pre√ßo para atingir a meta de margem.</li>
        <li><strong>Lucro:</strong> sobra ap√≥s custos e taxa do canal.</li>
        <li><strong>Margem L√≠quida:</strong> indicador real de rentabilidade.</li>
      </ul>

      <h3>üì¶ 9. Aba PRODUTOS</h3>
      <p>Hist√≥rico com nome, SKU, custo, pre√ßo, lucro, canal e margem. Permite compara√ß√£o, exporta√ß√£o e exclus√£o.</p>

      <h3>üìà 10. Estrat√©gia Recomendada</h3>
      <ul>
        <li>Margem m√≠nima recomendada: <strong>35%</strong>.</li>
        <li>Ideal para online: <strong>40% a 55%</strong>.</li>
        <li>Produtos personalizados: <strong>acima de 50%</strong>.</li>
        <li>Evite vender abaixo de <strong>30%</strong>.</li>
      </ul>

      <h3>üö® 11. Erros Comuns</h3>
      <ul>
        <li>N√£o considerar perdas.</li>
        <li>Esquecer o tempo de montagem.</li>
        <li>N√£o aplicar overhead.</li>
        <li>Copiar pre√ßo do concorrente sem c√°lculo.</li>
        <li>Ignorar taxas de marketplace.</li>
      </ul>

      <h3>üß† 12. Fluxo Ideal de Uso</h3>
      <ol>
        <li>Cadastrar madeiras.</li>
        <li>Ajustar par√¢metros.</li>
        <li>Calcular produto.</li>
        <li>Ajustar margem.</li>
        <li>Salvar e monitorar lucro.</li>
      </ol>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="tab-backup" class="hide">
    <div class="grid">
      <div class="card">
        <h2>Exportar</h2>
        <div class="muted">Gera um JSON com Madeiras + Par√¢metros + √∫ltimas entradas do Simulador.</div>
        <div class="btnbar">
          <button class="btn accent" id="btnExport">Baixar JSON</button>
          <button class="btn" id="btnReset">Resetar para padr√£o da planilha</button>
        </div>
      </div>

      <div class="card">
        <h2>Importar</h2>
        <div class="muted">Cole um JSON exportado aqui para restaurar.</div>
        <textarea id="importBox" rows="10" placeholder='Cole o JSON aqui'></textarea>
        <div class="btnbar">
          <button class="btn primary" id="btnImport">Importar JSON</button>
        </div>
      </div>
    </div>
  </section>
</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics.js";
  import {
    collection,
    deleteDoc,
    doc,
    getDoc,
    getDocs,
    getFirestore,
    orderBy,
    query,
    setDoc,
  } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
  // ====== DADOS INICIAIS (da planilha) ======
  const DEFAULT_DATA = {
    woods: [{"name": "MDF Cru 3mm", "thickness": 3, "width": 140, "height": 90, "price": 60, "obs": null}, {"name": "MDF Cru 6mm", "thickness": 6, "width": 140, "height": 90, "price": 130, "obs": null}, {"name": "MDF Branco 3mm", "thickness": 3, "width": 140, "height": 90, "price": 145, "obs": null}],
    params: {"custoHoraLaser": 30, "custoMaoObra": 18, "overhead": 1.5, "embalagem": 1.5, "perdasPct": 5, "taxas": {"Shopee": 20, "Mercado Livre": 16, "TikTok": 12}, "margemDesejada": 30},
    sim: {"wood": "MDF Cru 6mm", "comprimento": 80, "largura": 60, "areaCm2": 4800, "pctChapa": null, "tempoCorte": 10, "tempoGrav": 0, "tempoMont": 5, "canal": "Shopee", "margem": null, "nome": null, "sku": null},
    products: [],
    priceHistory: [],
    inventoryItems: [],
    inventoryMovements: [],
    dashboardOrders: [],
    orders: [],
    productionOrders: [],
    finance: {
      fixedCosts: [],
      entries: []
    }
  };

  const LS_KEY = "precificacao_mdf_laser_v1";

  // ====== FIREBASE (Produtos no banco, sem login) ======
  const USE_FIREBASE_PRODUCTS = true;
  const USE_FIREBASE_INVENTORY = true;
  const USE_FIREBASE_SETTINGS = true;
  const USE_FIREBASE_ORDERS = true;
  const USE_FIREBASE_FINANCE = true;
  const firebaseConfig = {
    apiKey: "AIzaSyCgaed-Dlv0DhhL4Mnw74chOML3NeNIgJc",
    authDomain: "mm-decor-626f8.firebaseapp.com",
    projectId: "mm-decor-626f8",
    storageBucket: "mm-decor-626f8.firebasestorage.app",
    messagingSenderId: "437485954448",
    appId: "1:437485954448:web:60a1aa6d05dd09c0677f15",
    measurementId: "G-SK44ZGCS1E",
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const db = getFirestore(firebaseApp);
  try {
    getAnalytics(firebaseApp);
  } catch (e) {
    console.warn("Analytics indispon√≠vel neste ambiente:", e?.message || e);
  }


  function loadState() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return structuredClone(DEFAULT_DATA);
      const obj = JSON.parse(raw);
      // merge leve (para compatibilidade futura)
      return {
        woods: Array.isArray(obj.woods) ? obj.woods : structuredClone(DEFAULT_DATA.woods),
        params: obj.params ? obj.params : structuredClone(DEFAULT_DATA.params),
        sim: obj.sim ? obj.sim : structuredClone(DEFAULT_DATA.sim),
        products: Array.isArray(obj.products) ? obj.products : structuredClone(DEFAULT_DATA.products),
        priceHistory: Array.isArray(obj.priceHistory) ? obj.priceHistory : [],
        inventoryItems: Array.isArray(obj.inventoryItems) ? obj.inventoryItems : [],
        inventoryMovements: Array.isArray(obj.inventoryMovements) ? obj.inventoryMovements : [],
        dashboardOrders: Array.isArray(obj.dashboardOrders) ? obj.dashboardOrders : [],
        orders: Array.isArray(obj.orders) ? obj.orders : [],
        productionOrders: Array.isArray(obj.productionOrders) ? obj.productionOrders : [],
        finance: {
          fixedCosts: Array.isArray(obj.finance?.fixedCosts) ? obj.finance.fixedCosts : [],
          entries: Array.isArray(obj.finance?.entries) ? obj.finance.entries : [],
        },
      };
    } catch(e) {
      console.warn("Falha ao ler localStorage:", e);
      return structuredClone(DEFAULT_DATA);
    }
  }

  function saveState() {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function debounce(fn, delay = 500) {
    let timer = null;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  }

  async function salvarConfiguracoesNoBanco() {
    if (!USE_FIREBASE_SETTINGS || !db) return;
    await setDoc(doc(db, "app_state", "settings"), {
      woods: state.woods || [],
      params: state.params || {},
      updatedAt: new Date().toISOString(),
    }, { merge: true });
  }

  async function carregarConfiguracoesDoBanco() {
    if (!USE_FIREBASE_SETTINGS || !db) return;
    const ref = doc(db, "app_state", "settings");
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await salvarConfiguracoesNoBanco();
      return;
    }
    const data = snap.data() || {};
    if (Array.isArray(data.woods)) state.woods = data.woods;
    if (data.params && typeof data.params === "object") state.params = data.params;
    saveState();
    loadParamsUI();
    renderWoods();
    fillSimSelect();
    fillProductWoodSelect();
    calcSim();
  }

  async function salvarPedidosNoBanco() {
    if (!USE_FIREBASE_ORDERS || !db) return;
    await Promise.all([
      ...((state.orders || []).map((o) => setDoc(doc(db, "orders", o.id), o, { merge: true }))),
      ...((state.productionOrders || []).map((op) => setDoc(doc(db, "production_orders", op.id), op, { merge: true }))),
    ]);
  }

  async function carregarPedidosDoBanco() {
    if (!USE_FIREBASE_ORDERS || !db) return;
    const [ordersSnap, productionSnap] = await Promise.all([
      getDocs(query(collection(db, "orders"), orderBy("updatedAt", "desc"))),
      getDocs(query(collection(db, "production_orders"), orderBy("createdAt", "desc"))),
    ]);

    const orders = ordersSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
    const productionOrders = productionSnap.docs.map((d) => ({ id: d.id, ...d.data() }));

    if (!ordersSnap.size && !productionSnap.size) {
      await salvarPedidosNoBanco();
      return;
    }

    state.orders = orders;
    state.productionOrders = productionOrders;
    saveState();
    resetOrderForm();
    renderOrders();
    renderDashboard();
  }

  async function salvarFinanceiroNoBanco() {
    if (!USE_FIREBASE_FINANCE || !db) return;
    await setDoc(doc(db, "finance", "main"), {
      fixedCosts: state.finance?.fixedCosts || [],
      entries: state.finance?.entries || [],
      updatedAt: new Date().toISOString(),
    }, { merge: true });
  }

  async function carregarFinanceiroDoBanco() {
    if (!USE_FIREBASE_FINANCE || !db) return;
    const ref = doc(db, "finance", "main");
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await salvarFinanceiroNoBanco();
      return;
    }
    const data = snap.data() || {};
    state.finance = {
      fixedCosts: Array.isArray(data.fixedCosts) ? data.fixedCosts : [],
      entries: Array.isArray(data.entries) ? data.entries : [],
    };
    saveState();
    renderFinance();
    renderDashboard();
  }

  const syncSettingsDebounced = debounce(() => {
    salvarConfiguracoesNoBanco().catch((e) => console.warn("Falha ao salvar configura√ß√µes no Firebase:", e));
  }, 600);

  let state = loadState();
  let lastCalc = null;

  // ====== UI: Tabs ======
  const tabButtons = document.querySelectorAll(".tab");
  tabButtons.forEach(btn => btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    document.querySelectorAll("section[id^='tab-']").forEach(s => s.classList.add("hide"));
    document.getElementById("tab-" + t).classList.remove("hide");
    if (t === "prod") carregarProdutosDoBanco();
    if (t === "estoque") carregarEstoqueDoBanco();
    if (t === "dashboard") renderDashboard();
    if (t === "pedidos") {
      renderOrders();
      carregarPedidosDoBanco().catch((e) => console.warn("Falha ao carregar pedidos do Firebase:", e));
    }
    if (t === "financeiro") {
      renderFinance();
      carregarFinanceiroDoBanco().catch((e) => console.warn("Falha ao carregar financeiro do Firebase:", e));
    }
  }));

  // ====== Helpers ======
  function n(v) {
    const x = Number(v);
    return Number.isFinite(x) ? x : null;
  }
  function fmtBRL(v) {
    if (v === null || v === "" || !Number.isFinite(v)) return "‚Äî";
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }
  function fmtPct(v) {
    if (v === null || v === "" || !Number.isFinite(v)) return "‚Äî";
    return (v*100).toLocaleString("pt-BR", { maximumFractionDigits: 2 }) + "%";
  }
  function fmtNum(v, dec = 2) {
    if (v === null || v === "" || !Number.isFinite(v)) return "‚Äî";
    return Number(v).toLocaleString("pt-BR", { minimumFractionDigits: dec, maximumFractionDigits: dec });
  }
  function clampNonNeg(x) {
    if (x === null) return null;
    return Math.max(0, x);
  }

  function woodComputed(w) {
    const width = n(w.width), height = n(w.height), price = n(w.price);
    const area = (width && height) ? (width * height)/10000 : null; // m¬≤
    const costm2 = (price && area) ? (price/area) : null;
    return {...w, area, costm2};
  }

  function getWoodByName(name) {
    return state.woods.find(w => w.name === name) || state.woods[0] || null;
  }

  // ====== SIMULADOR ======
  const el = {
    nome: document.getElementById("sim_nome"),
    sku: document.getElementById("sim_sku"),
    wood: document.getElementById("sim_wood"),
    comp: document.getElementById("sim_comp"),
    larg: document.getElementById("sim_larg"),
    pct: document.getElementById("sim_pct"),
    corte: document.getElementById("sim_corte"),
    grav: document.getElementById("sim_grav"),
    mont: document.getElementById("sim_mont"),
    canal: document.getElementById("sim_canal"),
    margem: document.getElementById("sim_margem"),
  };

  function fillSimSelect() {
    el.wood.innerHTML = "";
    state.woods.forEach(w => {
      const opt = document.createElement("option");
      opt.value = w.name;
      opt.textContent = w.name;
      el.wood.appendChild(opt);
    });
  }

  function loadSimInputsFromState() {
    fillSimSelect();
    el.nome.value = state.sim.nome ?? "";
    el.sku.value = state.sim.sku ?? "";
    el.wood.value = state.sim.wood || (state.woods[0]?.name ?? "");
    el.comp.value = state.sim.comprimento ?? "";
    el.larg.value = state.sim.largura ?? "";
    el.pct.value = state.sim.pctChapa ?? "";
    el.corte.value = state.sim.tempoCorte ?? "";
    el.grav.value = state.sim.tempoGrav ?? "";
    el.mont.value = state.sim.tempoMont ?? "";
    el.canal.value = state.sim.canal ?? "Shopee";
    el.margem.value = state.sim.margem ?? "";
  }

  function saveSimToState() {
    const prev = state.sim || {};
    const compVal = (el.comp.value === "" ? null : n(el.comp.value));
    const largVal = (el.larg.value === "" ? null : n(el.larg.value));
    const derivedArea = (compVal !== null && largVal !== null) ? (compVal * largVal) : null;

    state.sim = {
      nome: (el.nome?.value ?? "").trim() || null,
      sku: (el.sku?.value ?? "").trim() || null,
      wood: el.wood.value,
      comprimento: compVal,
      largura: largVal,
      // compatibilidade: mantemos areaCm2 para c√°lculos/backup.
      // - Se tiver comprimento e largura, areaCm2 = comprimento√ólargura
      // - Se ambos estiverem vazios, preserva o valor antigo (para n√£o "quebrar" quem j√° tinha salvo √°rea)
      // - Se s√≥ um deles for preenchido, areaCm2 fica null at√© completar os dois
      areaCm2: (derivedArea !== null) ? derivedArea : ((compVal === null && largVal === null) ? (n(prev.areaCm2) ?? null) : null),
      pctChapa: el.pct.value === "" ? null : n(el.pct.value),
      tempoCorte: el.corte.value === "" ? null : n(el.corte.value),
      tempoGrav: el.grav.value === "" ? null : n(el.grav.value),
      tempoMont: el.mont.value === "" ? null : n(el.mont.value),
      canal: el.canal.value,
      margem: el.margem.value === "" ? null : n(el.margem.value),
    };
    saveState();
  }


  function calcSim() {
    saveSimToState();
    const w0 = getWoodByName(state.sim.wood);
    const w = w0 ? woodComputed(w0) : null;

    // inputs
    const comp = clampNonNeg(n(state.sim.comprimento));
    const larg = clampNonNeg(n(state.sim.largura));
    // √Årea calculada a partir de comprimento√ólargura. Se n√£o tiver, usa areaCm2 antigo (compatibilidade).
    const areaCm2 = (comp !== null && comp !== 0 && larg !== null && larg !== 0)
      ? (comp * larg)
      : clampNonNeg(n(state.sim.areaCm2));
    const pctChapa = clampNonNeg(n(state.sim.pctChapa));
    const tCorte = clampNonNeg(n(state.sim.tempoCorte)) ?? 0;
    const tGrav  = clampNonNeg(n(state.sim.tempoGrav)) ?? 0;
    const tMont  = clampNonNeg(n(state.sim.tempoMont)) ?? 0;

    const canal = state.sim.canal || "Shopee";

    // params
    const p = state.params;
    const custoHoraLaser = n(p.custoHoraLaser) ?? 0;
    const custoMaoObra = n(p.custoMaoObra) ?? 0;
    const overhead = n(p.overhead) ?? 0;
    const embalagem = n(p.embalagem) ?? 0;
    const perdasPct = n(p.perdasPct) ?? 0;

    const taxaCanal = n(p.taxas?.[canal]) ?? 0;
    const margemUsada = (state.sim.margem === null || state.sim.margem === "" || !Number.isFinite(n(state.sim.margem)))
      ? (n(p.margemDesejada) ?? 0)
      : (n(state.sim.margem) ?? 0);

    // custo MDF da pe√ßa (replica planilha)
    let custoMdf = null;
    if (w) {
      if (pctChapa !== null && pctChapa !== 0) {
        const price = n(w.price);
        custoMdf = price !== null ? (price * (pctChapa/100)) : null;
      } else if (areaCm2 !== null && areaCm2 !== 0) {
        const costm2 = n(w.costm2);
        custoMdf = costm2 !== null ? (costm2 * (areaCm2/10000)) : null;
      } else {
        custoMdf = 0;
      }
    }

    const custoLaser = (custoHoraLaser/60) * (tCorte + tGrav);
    const custoMao = (custoMaoObra/60) * (tMont);
    const custoBase = (custoMdf ?? 0) + custoLaser + custoMao + overhead + embalagem;
    const ajustePerdas = custoBase * (perdasPct/100);
    const custoTotal = custoBase + ajustePerdas;

    const denom = 1 - (taxaCanal/100) - (margemUsada/100);
    const preco = (denom > 0) ? (custoTotal / denom) : null;

    const lucro = (preco !== null) ? (preco - custoTotal - (preco*(taxaCanal/100))) : null;
    const margemLiq = (preco !== null && preco !== 0 && lucro !== null) ? (lucro/preco) : null;

    // snapshot do c√°lculo atual (para salvar em Produtos)
    lastCalc = {
      ts: new Date().toISOString(),
      nome: state.sim.nome ?? null,
      sku: state.sim.sku ?? null,
      wood: w?.name ?? null,
      canal,
      taxaCanal,
      margemUsada,
      comp, larg, areaCm2, pctChapa,
      tCorte, tGrav, tMont,
      custoMdf: (custoMdf ?? 0),
      custoLaser,
      custoMao,
      overhead,
      embalagem,
      perdasPct,
      ajustePerdas,
      custoBase,
      custoTotal,
      preco,
      lucro,
      margemLiq,
    };

    // render
    const note = document.getElementById("noteWood");
    if (!w) {
      note.textContent = "Cadastre uma madeira para usar o simulador.";
    } else {
      const area = w.area ? w.area.toLocaleString("pt-BR", {maximumFractionDigits: 4}) : "‚Äî";
      const costm2 = w.costm2 ? fmtBRL(w.costm2) : "‚Äî";
      note.innerHTML = `<b>${w.name}</b> ‚Ä¢ ${w.thickness ?? "‚Äî"}mm ‚Ä¢ Chapa: ${w.width ?? "‚Äî"}√ó${w.height ?? "‚Äî"}cm ‚Ä¢ √Årea: ${area} m¬≤ ‚Ä¢ Custo/m¬≤: ${costm2}`;
    }

    document.getElementById("k_custo_total").textContent = fmtBRL(custoTotal);
    document.getElementById("k_preco").textContent = fmtBRL(preco);
    document.getElementById("k_lucro").textContent = fmtBRL(lucro);
    document.getElementById("k_margem_liq").textContent = (margemLiq === null) ? "‚Äî" : fmtPct(margemLiq);

    document.getElementById("d_mdf").textContent = fmtBRL(custoMdf ?? 0);
    document.getElementById("d_laser").textContent = fmtBRL(custoLaser);
    document.getElementById("d_mao").textContent = fmtBRL(custoMao);
    document.getElementById("d_over").textContent = fmtBRL(overhead);
    document.getElementById("d_emb").textContent = fmtBRL(embalagem);
    document.getElementById("d_base").textContent = fmtBRL(custoBase);
    document.getElementById("d_perdas").textContent = fmtBRL(ajustePerdas);
    document.getElementById("d_taxa").textContent = (taxaCanal/100).toLocaleString("pt-BR", {style:"percent", maximumFractionDigits:2});
    document.getElementById("d_margem_used").textContent = (margemUsada/100).toLocaleString("pt-BR", {style:"percent", maximumFractionDigits:2});
  }

  // auto recalcular em mudan√ßas
  Object.values(el).forEach(x => x.addEventListener("input", calcSim));
  el.wood.addEventListener("change", calcSim);
  el.canal.addEventListener("change", calcSim);

  document.getElementById("btnRecalcular").addEventListener("click", calcSim);
  document.getElementById("btnLimpar").addEventListener("click", () => {
    el.comp.value = "";
    el.larg.value = "";
    el.pct.value = "";
    el.margem.value = "";
    // garantir limpeza total (inclui compatibilidade de √°rea antiga)
    state.sim = {...(state.sim || {}), comprimento: null, largura: null, areaCm2: null};
    saveSimToState();
    calcSim();
  });

  // ====== MADEIRAS CRUD ======
  const woodsBody = document.querySelector("#woodsTable tbody");

  function renderWoods() {
    woodsBody.innerHTML = "";
    state.woods.forEach((w, idx) => {
      const wc = woodComputed(w);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input data-k="name" data-i="${idx}" value="${(w.name ?? "").replaceAll('"','&quot;')}" /></td>
        <td class="right"><input data-k="thickness" data-i="${idx}" type="number" step="0.01" value="${w.thickness ?? ""}" /></td>
        <td class="right"><input data-k="width" data-i="${idx}" type="number" step="0.01" value="${w.width ?? ""}" /></td>
        <td class="right"><input data-k="height" data-i="${idx}" type="number" step="0.01" value="${w.height ?? ""}" /></td>
        <td class="right"><input data-k="price" data-i="${idx}" type="number" step="0.01" value="${w.price ?? ""}" /></td>
        <td class="right">${wc.area ? wc.area.toLocaleString("pt-BR", {maximumFractionDigits:4}) : "‚Äî"}</td>
        <td class="right">${wc.costm2 ? fmtBRL(wc.costm2) : "‚Äî"}</td>
        <td><input data-k="obs" data-i="${idx}" value="${(w.obs ?? "").replaceAll('"','&quot;')}" /></td>
        <td class="right"><button class="btn danger" data-del="${idx}">Excluir</button></td>
      `;
      woodsBody.appendChild(tr);
    });

    // bind inputs
    woodsBody.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", () => {
        const i = Number(inp.dataset.i);
        const k = inp.dataset.k;
        if (!Number.isFinite(i)) return;
        const val = inp.value;
        // tipos num√©ricos
        if (["thickness","width","height","price"].includes(k)) {
          state.woods[i][k] = val === "" ? null : Number(val);
        } else {
          state.woods[i][k] = val === "" ? null : val;
        }
        saveState();
        syncSettingsDebounced();
        fillSimSelect();
        fillProductWoodSelect();
        calcSim();
        renderWoods(); // re-render pra atualizar √°rea/custo
      });
    });

    // bind delete
    woodsBody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.dataset.del);
        state.woods.splice(i,1);
        if (state.woods.length === 0) {
          state.woods = structuredClone(DEFAULT_DATA.woods);
        }
        saveState();
        syncSettingsDebounced();
        fillSimSelect();
        fillProductWoodSelect();
        renderWoods();
        calcSim();
      });
    });
  }

  document.getElementById("btnAddWood").addEventListener("click", () => {
    state.woods.push({name:"Nova madeira", thickness:null, width:null, height:null, price:null, obs:null});
    saveState();
    syncSettingsDebounced();
    renderWoods();
    fillSimSelect();
    fillProductWoodSelect();
  });



  // ====== M√ìDULO PRODUTOS ======
  const prodBody = document.querySelector("#prodTable tbody");
  const histBody = document.querySelector("#histTable tbody");
  const produtoForm = {
    nome: document.getElementById("prod_nome"),
    sku: document.getElementById("prod_sku"),
    categoria: document.getElementById("prod_categoria"),
    wood: document.getElementById("prod_wood"),
    espessura: document.getElementById("prod_espessura"),
    ativo: document.getElementById("prod_ativo"),
    comp: document.getElementById("prod_comp"),
    larg: document.getElementById("prod_larg"),
    pct: document.getElementById("prod_pct"),
    corte: document.getElementById("prod_corte"),
    gravacao: document.getElementById("prod_gravacao"),
    montagem: document.getElementById("prod_montagem"),
    embalagem: document.getElementById("prod_embalagem"),
    canal: document.getElementById("prod_canal"),
    margem: document.getElementById("prod_margem"),
    obs: document.getElementById("prod_obs"),
  };
  let editingProductId = null;
  let lastProductCalc = null;

  function fmtDT(iso) {
    try { return new Date(iso).toLocaleString("pt-BR", { dateStyle:"short", timeStyle:"short"}); }
    catch(e){ return iso || "‚Äî"; }
  }

  function fillProductWoodSelect() {
    produtoForm.wood.innerHTML = "";
    state.woods.forEach(w => {
      const opt = document.createElement("option");
      opt.value = w.name;
      opt.textContent = `${w.name} (${w.thickness ?? "‚Äî"}mm)`;
      produtoForm.wood.appendChild(opt);
    });
  }

  function resetProdutoForm() {
    editingProductId = null;
    Object.values(produtoForm).forEach((x) => { if (x.tagName === "SELECT") return; x.value = ""; });
    produtoForm.ativo.value = "true";
    produtoForm.canal.value = "Shopee";
    produtoForm.wood.value = state.woods[0]?.name || "";
    produtoForm.embalagem.value = state.params.embalagem ?? 0;
    produtoForm.margem.value = state.params.margemDesejada ?? 0;
    document.getElementById("prodResumoCalc").textContent = "Preencha os dados e clique em recalcular.";
    lastProductCalc = null;
  }

  function computeProdutoFromForm() {
    const w = woodComputed(getWoodByName(produtoForm.wood.value) || {});
    const comp = n(produtoForm.comp.value) ?? 0;
    const larg = n(produtoForm.larg.value) ?? 0;
    const pctChapa = n(produtoForm.pct.value);
    const tCorte = n(produtoForm.corte.value) ?? 0;
    const tGrav = n(produtoForm.gravacao.value) ?? 0;
    const tMont = n(produtoForm.montagem.value) ?? 0;
    const embalagem = n(produtoForm.embalagem.value) ?? 0;
    const canal = produtoForm.canal.value || "Shopee";
    const margemDesejada = n(produtoForm.margem.value) ?? (n(state.params.margemDesejada) ?? 0);
    const taxaCanal = n(state.params.taxas?.[canal]) ?? 0;
    const areaCm2 = comp * larg;

    let custoMdf = 0;
    if (pctChapa && n(w.price) !== null) custoMdf = n(w.price) * (pctChapa/100);
    else if (areaCm2 && n(w.costm2) !== null) custoMdf = n(w.costm2) * (areaCm2/10000);

    const custoLaser = ((n(state.params.custoHoraLaser) ?? 0)/60) * (tCorte + tGrav);
    const custoMao = ((n(state.params.custoMaoObra) ?? 0)/60) * tMont;
    const perdasPct = n(state.params.perdasPct) ?? 0;
    const overheadPct = n(state.params.overhead) ?? 0;

    const subtotal = custoMdf + custoLaser + custoMao + embalagem;
    const ajustePerdas = subtotal * (perdasPct/100);
    const overhead = subtotal * (overheadPct/100);
    const custoTotal = subtotal + ajustePerdas + overhead;

    const preco = custoTotal * (1 + margemDesejada/100 + taxaCanal/100);
    const lucro = preco - custoTotal;
    const margemLiquida = preco > 0 ? (lucro/preco) : 0;

    return {
      nome: produtoForm.nome.value.trim(),
      sku: produtoForm.sku.value.trim(),
      categoria: produtoForm.categoria.value.trim(),
      woodId: produtoForm.wood.value,
      madeira: w.name || null,
      espessura: produtoForm.espessura.value.trim() || (w.thickness ? `${w.thickness}mm` : null),
      dimensoes: { comp, larg, pctChapa: pctChapa ?? null },
      tempos: { corte: tCorte, gravacao: tGrav, montagem: tMont },
      embalagem,
      observacoesTecnicas: produtoForm.obs.value.trim() || null,
      canal,
      taxaCanal,
      margemDesejada,
      custoMdf,
      custoLaser,
      custoMao,
      ajustePerdas,
      overhead,
      custoTotal,
      precoSugerido: preco,
      lucro,
      margemLiquida,
      ativo: produtoForm.ativo.value === "true",
      updatedAt: new Date().toISOString(),
    };
  }

  function renderProducts() {
    if (!prodBody) return;
    prodBody.innerHTML = "";
    if (!state.products?.length) {
      prodBody.innerHTML = '<tr><td colspan="8" class="muted">Nenhum produto cadastrado.</td></tr>';
      return;
    }
    state.products.forEach((p) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.nome ?? "‚Äî"}</td>
        <td>${p.sku ?? "‚Äî"}</td>
        <td class="right">${fmtBRL(p.custoTotal ?? 0)}</td>
        <td class="right">${fmtBRL(p.precoSugerido ?? 0)}</td>
        <td class="right">${fmtBRL(p.lucro ?? 0)}</td>
        <td class="right">${fmtPct(p.margemLiquida ?? 0)}</td>
        <td><span class="pill">${p.ativo ? "Ativo" : "Inativo"}</span></td>
        <td class="right">
          <button class="btn" data-pedit="${p.id}">Editar</button>
          <button class="btn accent" data-pdup="${p.id}">Duplicar</button>
          <button class="btn" data-pop="${p.id}">Gerar OP</button>
          <button class="btn danger" data-parq="${p.id}">Arquivar</button>
        </td>`;
      prodBody.appendChild(tr);
    });

    prodBody.querySelectorAll("button[data-pedit]").forEach((btn) => btn.addEventListener("click", () => loadProductInForm(btn.dataset.pedit)));
    prodBody.querySelectorAll("button[data-pdup]").forEach((btn) => btn.addEventListener("click", () => duplicarProduto(btn.dataset.pdup)));
    prodBody.querySelectorAll("button[data-pop]").forEach((btn) => btn.addEventListener("click", () => gerarOrdemProducao(btn.dataset.pop)));
    prodBody.querySelectorAll("button[data-parq]").forEach((btn) => btn.addEventListener("click", () => arquivarProduto(btn.dataset.parq)));
  }

  function renderHistorico() {
    histBody.innerHTML = "";
    const rows = (state.priceHistory || []).slice().sort((a,b)=> (b.data||"").localeCompare(a.data||""));
    if (!rows.length) {
      histBody.innerHTML = '<tr><td colspan="6" class="muted">Sem snapshots de precifica√ß√£o.</td></tr>';
      return;
    }
    rows.forEach((h) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${fmtDT(h.data)}</td><td>${h.nome || "‚Äî"} / ${h.sku || "‚Äî"}</td><td class="right">${fmtBRL(h.custoTotal)}</td><td class="right">${fmtBRL(h.preco)}</td><td class="right">${fmtPct(h.margem)}</td><td>${h.canal || "‚Äî"}</td>`;
      histBody.appendChild(tr);
    });
  }

  async function carregarProdutosDoBanco() {
    if (!USE_FIREBASE_PRODUCTS || !db) return;
    const snap = await getDocs(query(collection(db, "products"), orderBy("updatedAt", "desc")));
    state.products = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
    renderProducts();
    resetOrderForm();
    renderOrders();
    renderHistorico();
    renderDashboard();
  }

  function loadProductInForm(id) {
    const p = state.products.find((x) => x.id === id);
    if (!p) return;
    editingProductId = id;
    produtoForm.nome.value = p.nome || "";
    produtoForm.sku.value = p.sku || "";
    produtoForm.categoria.value = p.categoria || "";
    produtoForm.wood.value = p.woodId || p.madeira || "";
    produtoForm.espessura.value = p.espessura || "";
    produtoForm.ativo.value = String(!!p.ativo);
    produtoForm.comp.value = p.dimensoes?.comp ?? "";
    produtoForm.larg.value = p.dimensoes?.larg ?? "";
    produtoForm.pct.value = p.dimensoes?.pctChapa ?? "";
    produtoForm.corte.value = p.tempos?.corte ?? "";
    produtoForm.gravacao.value = p.tempos?.gravacao ?? "";
    produtoForm.montagem.value = p.tempos?.montagem ?? "";
    produtoForm.embalagem.value = p.embalagem ?? "";
    produtoForm.obs.value = p.observacoesTecnicas ?? "";
    produtoForm.canal.value = p.canal || "Shopee";
    produtoForm.margem.value = p.margemDesejada ?? "";
    lastProductCalc = p;
  }

  async function arquivarProduto(id) {
    const p = state.products.find((x) => x.id === id);
    if (!p) return;
    p.ativo = false;
    p.updatedAt = new Date().toISOString();
    if (USE_FIREBASE_PRODUCTS && db && p.id) await setDoc(doc(db, "products", p.id), p, { merge: true });
    saveState();
    renderProducts();
  }

  function duplicarProduto(id) {
    const p = state.products.find((x) => x.id === id);
    if (!p) return;
    const novo = { ...structuredClone(p), id: null, sku: `${p.sku || "SKU"}-COPY`, nome: `${p.nome || "Produto"} (C√≥pia)`, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
    editingProductId = null;
    loadProductInForm(id);
    produtoForm.nome.value = novo.nome;
    produtoForm.sku.value = novo.sku;
  }

  // ====== ESTOQUE ======
  const invItemsBody = document.querySelector("#invItemsTable tbody");
  const invMovBody = document.querySelector("#invMovTable tbody");
  const invForm = {
    type: document.getElementById("invMovType"),
    item: document.getElementById("invMovItem"),
    qty: document.getElementById("invMovQty"),
    reason: document.getElementById("invMovReason"),
    obs: document.getElementById("invMovObs"),
  };

  function inventoryStatus(item) {
    return (n(item.quantidadeAtual) ?? 0) <= (n(item.estoqueMinimo) ?? 0) ? "Baixo" : "OK";
  }

  function inventoryItemLabel(item) {
    if (!item) return "‚Äî";
    const dim = item.largura && item.altura ? ` ${item.largura}x${item.altura}` : "";
    return `${item.nome || "Item"}${dim}`;
  }

  function buildInventoryMovement(itemId, tipo, quantidade, motivo, observacao = "") {
    const qty = Math.max(0, n(quantidade) ?? 0);
    return {
      id: crypto?.randomUUID?.() || String(Date.now() + Math.random()),
      itemId,
      tipo,
      quantidade: qty,
      motivo: motivo || "Ajuste manual",
      observacao: observacao || null,
      createdAt: new Date().toISOString(),
    };
  }

  async function persistInventoryMovement(mov) {
    state.inventoryMovements = state.inventoryMovements || [];
    state.inventoryMovements.push(mov);
    if (USE_FIREBASE_INVENTORY && db) {
      await setDoc(doc(db, "inventory_movements", mov.id), mov, { merge: true });
    }
  }

  async function applyInventoryMovement(mov) {
    const item = (state.inventoryItems || []).find((x) => x.id === mov.itemId);
    if (!item) throw new Error("Item de estoque n√£o encontrado.");
    const atual = n(item.quantidadeAtual) ?? 0;
    const delta = mov.tipo === "saida" ? -mov.quantidade : mov.quantidade;
    const novoSaldo = atual + delta;
    if (novoSaldo < 0) throw new Error(`Saldo insuficiente para ${item.nome}.`);
    item.quantidadeAtual = Number(novoSaldo.toFixed(4));
    item.updatedAt = new Date().toISOString();
    await persistInventoryMovement(mov);
    if (USE_FIREBASE_INVENTORY && db) {
      await setDoc(doc(db, "inventory_items", item.id), item, { merge: true });
    }
    saveState();
    renderInventory();
    renderDashboard();
  }

  function ensureInventorySeeds() {
    state.inventoryItems = state.inventoryItems || [];
    if (state.inventoryItems.length) return;
    const now = new Date().toISOString();
    const seeds = [
      { nome: "MDF Cru 6mm", tipo: "MDF", espessura: 6, largura: 183, altura: 275, quantidadeAtual: 8, estoqueMinimo: 4, valorUnitario: 130, custoMedioAtual: 130 },
      { nome: "MDF Cru 3mm", tipo: "MDF", espessura: 3, largura: 183, altura: 275, quantidadeAtual: 3, estoqueMinimo: 3, valorUnitario: 85, custoMedioAtual: 85 },
      { nome: "Caixa P", tipo: "EMBALAGEM", espessura: null, largura: null, altura: null, quantidadeAtual: 120, estoqueMinimo: 40, valorUnitario: 1.2, custoMedioAtual: 1.2 },
    ].map((x) => ({ ...x, id: crypto?.randomUUID?.() || String(Date.now() + Math.random()), createdAt: now, updatedAt: now }));
    state.inventoryItems = seeds;
  }

  function fillInventoryMaterialSelect() {
    invForm.item.innerHTML = "";
    (state.inventoryItems || []).forEach((item) => {
      const opt = document.createElement("option");
      opt.value = item.id;
      opt.textContent = `${item.nome} (${item.tipo})`;
      invForm.item.appendChild(opt);
    });
  }

  function renderInventorySummary() {
    const items = state.inventoryItems || [];
    const mdfTotal = items.filter((x) => x.tipo === "MDF").reduce((acc, x) => acc + (n(x.quantidadeAtual) ?? 0), 0);
    const embTotal = items.filter((x) => x.tipo === "EMBALAGEM").reduce((acc, x) => acc + (n(x.quantidadeAtual) ?? 0), 0);
    const lows = items.filter((x) => inventoryStatus(x) === "Baixo");
    const latest = [...items, ...(state.inventoryMovements || [])].map((x) => x.updatedAt || x.createdAt).filter(Boolean).sort().pop();

    document.getElementById("invTotalMdf").textContent = `${fmtNum(mdfTotal, 2)} chapas`;
    document.getElementById("invTotalEmb").textContent = `${fmtNum(embTotal, 0)} unidades`;
    document.getElementById("invAlerts").textContent = lows.length ? `üî¥ ${lows.length} item(ns)` : "‚úÖ Sem alertas";
    document.getElementById("invUpdated").textContent = latest ? fmtDT(latest) : "‚Äî";
  }

  function renderInventoryItems() {
    invItemsBody.innerHTML = "";
    const items = state.inventoryItems || [];
    if (!items.length) {
      invItemsBody.innerHTML = '<tr><td colspan="10" class="muted">Sem materiais cadastrados.</td></tr>';
      return;
    }

    items.forEach((item) => {
      const tr = document.createElement("tr");
      const status = inventoryStatus(item);
      tr.innerHTML = `
        <td>${item.nome || "‚Äî"}</td>
        <td>${item.tipo || "‚Äî"}</td>
        <td class="right">${item.tipo === "MDF" ? fmtNum(item.espessura ?? 0, 0) : "‚Äî"}</td>
        <td class="right">${item.tipo === "MDF" && item.largura && item.altura ? `${item.largura}x${item.altura}` : "‚Äî"}</td>
        <td class="right">${fmtNum(item.quantidadeAtual ?? 0, item.tipo === "MDF" ? 2 : 0)}</td>
        <td class="right">${fmtNum(item.estoqueMinimo ?? 0, item.tipo === "MDF" ? 2 : 0)}</td>
        <td class="right">${fmtBRL(item.valorUnitario ?? 0)}</td>
        <td class="right">${fmtBRL(item.custoMedioAtual ?? item.valorUnitario ?? 0)}</td>
        <td><span class="pill ${status === "Baixo" ? "low" : "ok"}">${status === "Baixo" ? "üî¥ Estoque baixo" : "OK"}</span></td>
        <td class="right"><button class="btn" data-iedit="${item.id}">Editar</button></td>`;
      invItemsBody.appendChild(tr);
    });

    invItemsBody.querySelectorAll("button[data-iedit]").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const item = state.inventoryItems.find((x) => x.id === btn.dataset.iedit);
        if (!item) return;
        const nome = prompt("Nome", item.nome || "");
        if (!nome) return;
        const quantidadeAtual = n(prompt("Quantidade atual", String(item.quantidadeAtual ?? 0)));
        const estoqueMinimo = n(prompt("Estoque m√≠nimo", String(item.estoqueMinimo ?? 0)));
        item.nome = nome;
        item.quantidadeAtual = quantidadeAtual ?? 0;
        item.estoqueMinimo = estoqueMinimo ?? 0;
        item.updatedAt = new Date().toISOString();
        if (USE_FIREBASE_INVENTORY && db) await setDoc(doc(db, "inventory_items", item.id), item, { merge: true });
        saveState();
        renderInventory();
      });
    });
  }

  function renderInventoryMovements() {
    invMovBody.innerHTML = "";
    const rows = (state.inventoryMovements || []).slice().sort((a, b) => (b.createdAt || "").localeCompare(a.createdAt || ""));
    if (!rows.length) {
      invMovBody.innerHTML = '<tr><td colspan="6" class="muted">Sem movimenta√ß√µes.</td></tr>';
      return;
    }
    rows.forEach((mov) => {
      const item = (state.inventoryItems || []).find((x) => x.id === mov.itemId);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${fmtDT(mov.createdAt)}</td><td>${mov.tipo === "entrada" ? "Entrada" : "Sa√≠da"}</td><td>${inventoryItemLabel(item)}</td><td class="right">${fmtNum(mov.quantidade, 2)}</td><td>${mov.motivo || "‚Äî"}</td><td>${mov.observacao || "‚Äî"}</td>`;
      invMovBody.appendChild(tr);
    });
  }

  function renderInventory() {
    fillInventoryMaterialSelect();
    renderInventorySummary();
    renderInventoryItems();
    renderInventoryMovements();
  }

  async function carregarEstoqueDoBanco() {
    if (!USE_FIREBASE_INVENTORY || !db) {
      ensureInventorySeeds();
      renderInventory();
      return;
    }
    const [itemsSnap, movSnap] = await Promise.all([
      getDocs(query(collection(db, "inventory_items"), orderBy("updatedAt", "desc"))),
      getDocs(query(collection(db, "inventory_movements"), orderBy("createdAt", "desc"))),
    ]);
    state.inventoryItems = itemsSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
    state.inventoryMovements = movSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
    ensureInventorySeeds();
    saveState();
    renderInventory();
    renderDashboard();
    if (!itemsSnap.size && state.inventoryItems.length) {
      await Promise.all(state.inventoryItems.map((item) => setDoc(doc(db, "inventory_items", item.id), item, { merge: true })));
    }
  }

  async function adicionarItemEstoque() {
    const tipo = (prompt("Tipo (MDF ou EMBALAGEM)", "MDF") || "MDF").toUpperCase();
    const nome = prompt("Nome do material", tipo === "MDF" ? "MDF 6mm Cru" : "Caixa P");
    if (!nome) return;
    const now = new Date().toISOString();
    const item = {
      id: crypto?.randomUUID?.() || String(Date.now() + Math.random()),
      nome,
      tipo: tipo === "EMBALAGEM" ? "EMBALAGEM" : "MDF",
      espessura: tipo === "MDF" ? (n(prompt("Espessura (mm)", "6")) ?? null) : null,
      largura: tipo === "MDF" ? (n(prompt("Largura da chapa", "183")) ?? null) : null,
      altura: tipo === "MDF" ? (n(prompt("Altura da chapa", "275")) ?? null) : null,
      quantidadeAtual: n(prompt("Quantidade atual", "0")) ?? 0,
      estoqueMinimo: n(prompt("Estoque m√≠nimo", "0")) ?? 0,
      valorUnitario: n(prompt("Valor unit√°rio", "0")) ?? 0,
      custoMedioAtual: n(prompt("Custo m√©dio atual", "0")) ?? 0,
      createdAt: now,
      updatedAt: now,
    };
    state.inventoryItems.push(item);
    if (USE_FIREBASE_INVENTORY && db) await setDoc(doc(db, "inventory_items", item.id), item, { merge: true });
    saveState();
    renderInventory();
    renderDashboard();
  }

  async function gerarOrdemProducao(productId) {
    const p = state.products.find((x) => x.id === productId);
    if (!p) return;
    const qtdOp = Math.max(1, n(prompt(`Quantidade da OP para ${p.nome}?`, "1")) ?? 1);

    const mdfItem = (state.inventoryItems || []).find((x) => x.tipo === "MDF" && (x.nome || "").toLowerCase().includes((p.madeira || "").toLowerCase().replace("mdf", "").trim()));
    const embItem = (state.inventoryItems || []).find((x) => x.tipo === "EMBALAGEM");
    const pctChapa = n(p.dimensoes?.pctChapa) ?? 0;
    const consumoMdf = pctChapa > 0 ? (pctChapa / 100) * qtdOp : 0;
    const consumoEmb = qtdOp;

    if (mdfItem && consumoMdf > 0) {
      await applyInventoryMovement(buildInventoryMovement(mdfItem.id, "saida", consumoMdf, "Produ√ß√£o", `OP ${p.sku || p.nome} x${qtdOp}`));
    }
    if (embItem && consumoEmb > 0) {
      await applyInventoryMovement(buildInventoryMovement(embItem.id, "saida", consumoEmb, "Produ√ß√£o", `OP ${p.sku || p.nome} x${qtdOp}`));
    }
    alert(`OP gerada. Baixas realizadas: MDF ${fmtNum(consumoMdf, 2)} chapa(s), Embalagem ${fmtNum(consumoEmb, 0)} un.`);
  }

  document.getElementById("btnAddInventoryItem").addEventListener("click", adicionarItemEstoque);
  document.getElementById("btnAddInventoryMovement").addEventListener("click", async () => {
    const mov = buildInventoryMovement(invForm.item.value, invForm.type.value, n(invForm.qty.value) ?? 0, invForm.reason.value, invForm.obs.value.trim());
    if (!mov.itemId) return alert("Selecione um material.");
    if (mov.quantidade <= 0) return alert("Informe uma quantidade v√°lida.");
    await applyInventoryMovement(mov);
    invForm.qty.value = "";
    invForm.obs.value = "";
  });

  document.getElementById("btnRecalcularProduto").addEventListener("click", () => {
    const calc = computeProdutoFromForm();
    if (!calc.nome || !calc.sku || !calc.categoria || !calc.woodId) return alert("Preencha Nome, SKU, Categoria e Madeira.");
    lastProductCalc = calc;
    document.getElementById("prodResumoCalc").innerHTML = `Custo total: <b>${fmtBRL(calc.custoTotal)}</b> | Pre√ßo sugerido: <b>${fmtBRL(calc.precoSugerido)}</b> | Lucro: <b>${fmtBRL(calc.lucro)}</b> | Margem l√≠quida: <b>${fmtPct(calc.margemLiquida)}</b>`;
  });

  document.getElementById("btnSalvarProdutoModulo").addEventListener("click", async () => {
    const calc = lastProductCalc || computeProdutoFromForm();
    if (!calc.nome || !calc.sku || !calc.categoria || !calc.woodId) return alert("Campos obrigat√≥rios: nome, SKU, categoria e madeira.");
    if (state.products.some((p) => p.sku === calc.sku && p.id !== editingProductId)) return alert("SKU j√° cadastrado. Use um SKU √∫nico.");

    const now = new Date().toISOString();
    const payload = { ...calc, createdAt: editingProductId ? (state.products.find(p=>p.id===editingProductId)?.createdAt || now) : now, updatedAt: now };

    if (editingProductId) {
      const i = state.products.findIndex((x) => x.id === editingProductId);
      if (i >= 0) state.products[i] = { ...state.products[i], ...payload, id: editingProductId };
      if (USE_FIREBASE_PRODUCTS && db) await setDoc(doc(db, "products", editingProductId), { ...payload }, { merge: true });
    } else {
      payload.id = crypto?.randomUUID?.() || String(Date.now());
      state.products.unshift(payload);
      if (USE_FIREBASE_PRODUCTS && db) await setDoc(doc(db, "products", payload.id), payload, { merge: true });
    }

    state.priceHistory = state.priceHistory || [];
    state.priceHistory.push({
      data: now,
      nome: payload.nome,
      sku: payload.sku,
      custoTotal: payload.custoTotal,
      preco: payload.precoSugerido,
      margem: payload.margemLiquida,
      canal: payload.canal,
    });

    saveState();
    renderProducts();
    renderHistorico();
    renderDashboard();
    resetProdutoForm();
  });

  document.getElementById("btnNovoProduto").addEventListener("click", resetProdutoForm);

  document.getElementById("btnSalvarProduto").addEventListener("click", () => {
    if (!lastCalc) return alert("Recalcule no Simulador antes de enviar para Produtos.");
    tabButtons.forEach(b => b.classList.remove("active"));
    document.querySelector('.tab[data-tab="prod"]').classList.add("active");
    document.querySelectorAll("section[id^='tab-']").forEach(s => s.classList.add("hide"));
    document.getElementById("tab-prod").classList.remove("hide");

    produtoForm.nome.value = el.nome.value || lastCalc.nome || "";
    produtoForm.sku.value = el.sku.value || lastCalc.sku || "";
    produtoForm.categoria.value = "";
    produtoForm.wood.value = lastCalc.wood || "";
    produtoForm.comp.value = lastCalc.comp ?? "";
    produtoForm.larg.value = lastCalc.larg ?? "";
    produtoForm.pct.value = lastCalc.pctChapa ?? "";
    produtoForm.corte.value = lastCalc.tCorte ?? "";
    produtoForm.gravacao.value = lastCalc.tGrav ?? "";
    produtoForm.montagem.value = lastCalc.tMont ?? "";
    produtoForm.embalagem.value = lastCalc.embalagem ?? state.params.embalagem ?? 0;
    produtoForm.canal.value = lastCalc.canal || "Shopee";
    produtoForm.margem.value = lastCalc.margemUsada ?? state.params.margemDesejada ?? 0;
  });

  // ====== PEDIDOS ======
  const ORDER_STATUS = [
    { value: "Or√ßamento", color: "#f5e9bf", text: "#886f23", icon: "üü°" },
    { value: "Aprovado", color: "#ddebfb", text: "#3d6792", icon: "üîµ" },
    { value: "Em Produ√ß√£o", color: "#f8dfc8", text: "#935d29", icon: "üü†" },
    { value: "Acabamento", color: "#eadff8", text: "#6a4a95", icon: "üü£" },
    { value: "Finalizado", color: "#ddeedb", text: "#4c7b49", icon: "üü¢" },
    { value: "Entregue", color: "#ececec", text: "#575757", icon: "‚ö´" },
    { value: "Cancelado", color: "#f6dada", text: "#974747", icon: "üî¥" },
  ];
  const orderBody = document.querySelector("#ordersTable tbody");
  const orderForm = {
    clienteNome: document.getElementById("order_clienteNome"), telefone: document.getElementById("order_telefone"), canal: document.getElementById("order_canal"), obs: document.getElementById("order_obs"),
    dataPedido: document.getElementById("order_dataPedido"), dataEntrega: document.getElementById("order_dataEntrega"), status: document.getElementById("order_status")
  };
  let editingOrderId = null;
  let orderItemsDraft = [];

  function ensureOrdersSeeds() {
    state.orders = state.orders || [];
    state.productionOrders = state.productionOrders || [];
    if (!state.orders.length && state.dashboardOrders?.length) {
      state.orders = state.dashboardOrders.map((o, idx) => ({
        id: o.id || (crypto?.randomUUID?.() || String(Date.now() + Math.random())),
        orderNumber: `PED-${String(idx+1).padStart(4,'0')}`,
        clienteNome: o.cliente || "Cliente", telefone: "", canal: "Shopee", observacoes: "",
        status: o.status || "Or√ßamento", dataPedido: (o.createdAt || new Date().toISOString()).slice(0,10), dataEntrega: (o.previstoPara || new Date().toISOString()).slice(0,10),
        itens: [], valorTotal: n(o.valorFinal) ?? 0, custoTotal: Math.max(0, (n(o.valorTotal) ?? 0) - (n(o.lucroTotal) ?? 0)), lucroTotal: n(o.lucroReal) ?? 0,
        minutosCorte: n(o.minutosCorte) ?? 0, minutosMontagem: n(o.minutosMontagem) ?? 0, createdAt: o.createdAt || new Date().toISOString(), updatedAt: new Date().toISOString(),
      }));
    }
  }
  function orderStatusMeta(status){ return ORDER_STATUS.find((s) => s.value === status) || ORDER_STATUS[0]; }
  function statusPill(status){ const m = orderStatusMeta(status); return `<span class="status-pill" style="background:${m.color};color:${m.text};">${m.icon} ${status}</span>`; }
  function newOrderNumber(){ const seq=(state.orders||[]).length+1; return `PED-${String(seq).padStart(4,'0')}`; }
  function productOptionsHtml(selected){ return `<option value="">Selecione</option>${(state.products||[]).map((p)=>`<option value="${p.id}" ${p.id===selected?'selected':''}>${p.nome||p.sku||'Produto'}</option>`).join('')}`; }

  function recalcOrderDraft() {
    orderItemsDraft = orderItemsDraft.map((it) => {
      const p = (state.products || []).find((x) => x.id === it.productId);
      const qtd = Math.max(1, n(it.quantidade) ?? 1);
      const precoUnit = n(it.precoUnit) ?? (n(p?.precoSugerido) ?? 0);
      const custoUnit = n(p?.custoTotal) ?? 0;
      const lucroUnit = precoUnit - custoUnit;
      return { ...it, nomeProduto: p?.nome || it.nomeProduto || "", quantidade: qtd, precoUnit, custoUnit, lucroUnit, subtotal: precoUnit * qtd, tempos: { corte: n(p?.tempos?.corte) ?? 0, montagem: n(p?.tempos?.montagem) ?? 0 } };
    });
    renderOrderItems();
    renderOrderSummary();
  }

  function renderOrderItems(){
    const grid = document.getElementById("orderItemsGrid");
    if (!grid) return;
    if (!orderItemsDraft.length) orderItemsDraft = [{ id: crypto?.randomUUID?.() || String(Date.now()), productId: "", quantidade: 1, precoUnit: 0 }];
    grid.innerHTML = `<div class="muted">Produto</div><div class="muted">Qtd</div><div class="muted">Pre√ßo unit.</div><div class="muted">Subtotal</div><div></div>` + orderItemsDraft.map((it)=>`<div class="order-item-row">
      <select data-item="${it.id}" data-field="productId">${productOptionsHtml(it.productId)}</select>
      <input data-item="${it.id}" data-field="quantidade" type="number" min="1" step="1" value="${it.quantidade ?? 1}" />
      <input data-item="${it.id}" data-field="precoUnit" type="number" step="0.01" value="${it.precoUnit ?? 0}" />
      <input value="${fmtBRL(it.subtotal ?? 0)}" disabled />
      <button class="btn danger" data-del-item="${it.id}">Remover</button>
    </div>`).join("");
    grid.querySelectorAll("[data-item]").forEach((el)=>el.addEventListener("input",()=>{
      const it = orderItemsDraft.find((x)=>x.id===el.dataset.item); if(!it) return;
      it[el.dataset.field]=el.value; recalcOrderDraft();
    }));
    grid.querySelectorAll("[data-del-item]").forEach((b)=>b.addEventListener("click",()=>{orderItemsDraft=orderItemsDraft.filter((x)=>x.id!==b.dataset.delItem); recalcOrderDraft();}));
  }

  function orderTotals(items){
    const valorTotal = items.reduce((a,i)=>a+(n(i.precoUnit)??0)*(n(i.quantidade)??0),0);
    const custoTotal = items.reduce((a,i)=>a+(n(i.custoUnit)??0)*(n(i.quantidade)??0),0);
    const lucroTotal = valorTotal - custoTotal;
    const margem = valorTotal>0 ? (lucroTotal/valorTotal)*100 : 0;
    const minutosCorte = items.reduce((a,i)=>a+(n(i.tempos?.corte)??0)*(n(i.quantidade)??0),0);
    const minutosMontagem = items.reduce((a,i)=>a+(n(i.tempos?.montagem)??0)*(n(i.quantidade)??0),0);
    return {valorTotal,custoTotal,lucroTotal,margem,minutosCorte,minutosMontagem};
  }

  function renderOrderSummary(){
    const t = orderTotals(orderItemsDraft);
    document.getElementById("orderResumoReceita").textContent = fmtBRL(t.valorTotal);
    document.getElementById("orderResumoCusto").textContent = fmtBRL(t.custoTotal);
    document.getElementById("orderResumoLucro").textContent = fmtBRL(t.lucroTotal);
    document.getElementById("orderResumoMargem").textContent = fmtNum(t.margem,1)+"%";
    const delay = document.getElementById("orderDelayAlert");
    const dtEntrega = orderForm.dataEntrega.value ? new Date(orderForm.dataEntrega.value+"T23:59:59") : null;
    const atrasado = dtEntrega && dtEntrega < new Date() && !["Finalizado","Entregue","Cancelado"].includes(orderForm.status.value);
    delay.textContent = atrasado ? "‚ö† Pedido atrasado: prazo vencido e pedido ainda n√£o finalizado." : "";
    delay.classList.toggle("hide", !atrasado);
  }

  function resetOrderForm(){
    editingOrderId = null;
    Object.values(orderForm).forEach((f)=>f.value="");
    orderForm.canal.value = "Shopee";
    orderForm.status.innerHTML = ORDER_STATUS.map((s)=>`<option value="${s.value}">${s.icon} ${s.value}</option>`).join("");
    orderForm.status.value = "Or√ßamento";
    const hoje = new Date().toISOString().slice(0,10);
    orderForm.dataPedido.value = hoje;
    orderForm.dataEntrega.value = hoje;
    orderItemsDraft = [{ id: crypto?.randomUUID?.() || String(Date.now()), productId: "", quantidade: 1, precoUnit: 0 }];
    recalcOrderDraft();
    document.getElementById("orderResumoProducao").textContent = "Sem OP gerada.";
  }

  function createProductionOrderIfNeeded(order, prevStatus){
    if (order.status !== "Aprovado" || prevStatus === "Aprovado") return;
    const exists = (state.productionOrders||[]).some((op)=>op.orderId===order.id);
    if (exists) return;
    state.productionOrders.push({
      id: crypto?.randomUUID?.() || String(Date.now()+Math.random()), orderId: order.id, orderNumber: order.orderNumber,
      minutosCorte: order.minutosCorte, minutosMontagem: order.minutosMontagem, status: "Aberta", createdAt: new Date().toISOString()
    });
  }

  function renderOrders(){
    if (!orderBody) return;
    orderBody.innerHTML = "";
    const rows=(state.orders||[]).slice().sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
    if(!rows.length){ orderBody.innerHTML='<tr><td colspan="9" class="muted">Nenhum pedido cadastrado.</td></tr>'; return; }
    rows.forEach((o)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${o.orderNumber||'‚Äî'}</td><td>${o.clienteNome||'‚Äî'}</td><td>${o.canal||'‚Äî'}</td><td>${o.dataPedido||'‚Äî'}</td><td>${o.dataEntrega||'‚Äî'}</td><td class="right">${fmtBRL(o.valorTotal||0)}</td><td class="right">${fmtBRL(o.lucroTotal||0)}</td><td>${statusPill(o.status||'Or√ßamento')}</td><td class="right"><button class="btn" data-oedit="${o.id}">Editar</button> <button class="btn danger" data-odel="${o.id}">Excluir</button></td>`;
      orderBody.appendChild(tr);
    });
    orderBody.querySelectorAll('[data-oedit]').forEach((b)=>b.addEventListener('click',()=>loadOrderForm(b.dataset.oedit)));
    orderBody.querySelectorAll('[data-odel]').forEach((b)=>b.addEventListener('click',()=>deleteOrder(b.dataset.odel)));
  }

  function deleteOrder(id){
    const target = (state.orders||[]).find((x)=>x.id===id);
    if (!target) return;
    if (!confirm(`Deseja excluir o pedido ${target.orderNumber||''}?`)) return;
    const productionToDelete = (state.productionOrders || []).filter((x) => x.orderId === id);
    state.orders = (state.orders||[]).filter((x)=>x.id!==id);
    state.productionOrders = (state.productionOrders||[]).filter((x)=>x.orderId!==id);
    if (editingOrderId === id) resetOrderForm();
    saveState();
    if (USE_FIREBASE_ORDERS && db) {
      deleteDoc(doc(db, "orders", id)).catch((e) => console.warn("Falha ao excluir pedido no Firebase:", e));
      Promise.all(productionToDelete.map((op) => deleteDoc(doc(db, "production_orders", op.id))))
        .catch((e) => console.warn("Falha ao excluir OP vinculada no Firebase:", e));
    }
    renderOrders();
    renderDashboard();
  }

  function loadOrderForm(id){
    const o=(state.orders||[]).find((x)=>x.id===id); if(!o) return;
    editingOrderId = id;
    orderForm.clienteNome.value=o.clienteNome||''; orderForm.telefone.value=o.telefone||''; orderForm.canal.value=o.canal||'Shopee';
    orderForm.obs.value=o.observacoes||''; orderForm.dataPedido.value=o.dataPedido||''; orderForm.dataEntrega.value=o.dataEntrega||'';
    orderForm.status.innerHTML = ORDER_STATUS.map((s)=>`<option value="${s.value}">${s.icon} ${s.value}</option>`).join("");
    orderForm.status.value=o.status||'Or√ßamento';
    orderItemsDraft=(o.itens||[]).map((it)=>({ ...it, id: crypto?.randomUUID?.() || String(Date.now()+Math.random()) }));
    recalcOrderDraft();
    const op = (state.productionOrders||[]).find((x)=>x.orderId===o.id);
    document.getElementById("orderResumoProducao").textContent = op ? `OP criada: Corte ${fmtNum(op.minutosCorte,0)} min ¬∑ Montagem ${fmtNum(op.minutosMontagem,0)} min` : 'Sem OP gerada.';
  }

  document.getElementById('btnNovoPedido').addEventListener('click', resetOrderForm);
  document.getElementById('btnAddOrderItem').addEventListener('click', ()=>{ orderItemsDraft.push({ id: crypto?.randomUUID?.() || String(Date.now()+Math.random()), productId: '', quantidade: 1, precoUnit: 0 }); recalcOrderDraft(); });
  [orderForm.dataEntrega, orderForm.status].forEach((f)=>f.addEventListener('input', renderOrderSummary));

  document.getElementById('btnSalvarPedido').addEventListener('click', async ()=>{
    if (!orderForm.clienteNome.value.trim()) return alert('Informe o nome do cliente.');
    const totals = orderTotals(orderItemsDraft);
    const now = new Date().toISOString();
    const prev = editingOrderId ? (state.orders||[]).find((x)=>x.id===editingOrderId) : null;
    const order = {
      id: editingOrderId || (crypto?.randomUUID?.() || String(Date.now()+Math.random())),
      orderNumber: prev?.orderNumber || newOrderNumber(),
      clienteNome: orderForm.clienteNome.value.trim(), telefone: orderForm.telefone.value.trim(), canal: orderForm.canal.value, observacoes: orderForm.obs.value.trim(),
      status: orderForm.status.value, dataPedido: orderForm.dataPedido.value, dataEntrega: orderForm.dataEntrega.value,
      itens: orderItemsDraft.map((it)=>({ productId: it.productId||null, nomeProduto: it.nomeProduto||'', quantidade: n(it.quantidade)??0, precoUnit: n(it.precoUnit)??0, custoUnit: n(it.custoUnit)??0, lucroUnit: n(it.lucroUnit)??0 })),
      valorTotal: totals.valorTotal, custoTotal: totals.custoTotal, lucroTotal: totals.lucroTotal, minutosCorte: totals.minutosCorte, minutosMontagem: totals.minutosMontagem,
      createdAt: prev?.createdAt || now, updatedAt: now
    };
    createProductionOrderIfNeeded(order, prev?.status);
    if (editingOrderId) { const i=state.orders.findIndex((x)=>x.id===editingOrderId); if(i>=0) state.orders[i]=order; }
    else state.orders.unshift(order);
    saveState();
    if (USE_FIREBASE_ORDERS && db) await setDoc(doc(db, "orders", order.id), order, { merge: true });
    const op = (state.productionOrders || []).find((x) => x.orderId === order.id);
    if (USE_FIREBASE_ORDERS && db && op?.id) await setDoc(doc(db, "production_orders", op.id), op, { merge: true });
    renderOrders();
    renderDashboard();
    loadOrderForm(order.id);
  });

  // ====== FINANCEIRO ======
  function currentMonthRange() {
    const now = new Date();
    return { month: now.getMonth(), year: now.getFullYear() };
  }

  function financeMonthData() {
    const range = currentMonthRange();
    const entries = (state.finance?.entries || []).filter((e) => {
      const dt = new Date((e.date || e.createdAt || new Date().toISOString()) + ((e.date || '').includes('T') ? '' : 'T00:00:00'));
      return dt.getMonth() === range.month && dt.getFullYear() === range.year;
    });
    const fixedCosts = (state.finance?.fixedCosts || []).reduce((acc, c) => acc + (n(c.value) ?? 0), 0);

    const entradaRecebida = entries
      .filter((e) => e.type === 'entrada' && e.status === 'recebido')
      .reduce((acc, e) => acc + (n(e.value) ?? 0), 0);
    const saidaPaga = entries
      .filter((e) => e.type === 'saida' && e.status === 'recebido')
      .reduce((acc, e) => acc + (n(e.value) ?? 0), 0);
    const pagamentoPendente = entries
      .filter((e) => e.type === 'saida' && e.status === 'pendente')
      .reduce((acc, e) => acc + (n(e.value) ?? 0), 0);

    const fluxoCaixa = entradaRecebida - saidaPaga;
    const lucroReal = entradaRecebida - saidaPaga - fixedCosts;

    return { entries, fixedCosts, entradaRecebida, saidaPaga, pagamentoPendente, fluxoCaixa, lucroReal };
  }

  function renderFinance() {
    const fixedBody = document.querySelector('#finFixedTable tbody');
    const entriesBody = document.querySelector('#finEntriesTable tbody');
    if (!fixedBody || !entriesBody) return;

    const data = financeMonthData();
    const dash = getDashboardData();

    document.getElementById('finEntradaRecebida').textContent = fmtBRL(data.entradaRecebida);
    document.getElementById('finPagamentoPendente').textContent = fmtBRL(data.pagamentoPendente);
    document.getElementById('finCustosFixos').textContent = fmtBRL(data.fixedCosts);
    document.getElementById('finFluxoCaixa').textContent = fmtBRL(data.fluxoCaixa);
    document.getElementById('finLucroEstimado').textContent = fmtBRL(dash.lucroMes);
    document.getElementById('finLucroReal').textContent = fmtBRL(data.lucroReal);

    const dif = data.lucroReal - (dash.lucroMes || 0);
    document.getElementById('finResumo').textContent = `Lucro real (${fmtBRL(data.lucroReal)}) x estimado (${fmtBRL(dash.lucroMes)}): diferen√ßa de ${fmtBRL(dif)}.`;

    fixedBody.innerHTML = ((state.finance?.fixedCosts || []).length
      ? (state.finance.fixedCosts || []).map((c) => `
        <tr>
          <td>${c.description || '‚Äî'}</td>
          <td class="right">${fmtBRL(n(c.value) ?? 0)}</td>
          <td class="right"><button class="btn danger" data-del-fixed="${c.id}">Excluir</button></td>
        </tr>`).join('')
      : '<tr><td colspan="3" class="muted">Nenhum custo fixo cadastrado.</td></tr>');

    entriesBody.innerHTML = (data.entries.length
      ? data.entries.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map((e) => `
        <tr>
          <td>${e.date ? new Date(e.date + 'T00:00:00').toLocaleDateString('pt-BR') : '‚Äî'}</td>
          <td>${e.type === 'entrada' ? 'Entrada' : 'Sa√≠da'}</td>
          <td>${e.status === 'pendente' ? 'Pendente' : 'Recebido/Pago'}</td>
          <td>${e.description || '‚Äî'}</td>
          <td class="right">${fmtBRL(n(e.value) ?? 0)}</td>
          <td class="right"><button class="btn danger" data-del-fin="${e.id}">Excluir</button></td>
        </tr>`).join('')
      : '<tr><td colspan="6" class="muted">Nenhum lan√ßamento financeiro no m√™s.</td></tr>');

    fixedBody.querySelectorAll('[data-del-fixed]').forEach((btn) => btn.addEventListener('click', () => {
      state.finance.fixedCosts = (state.finance.fixedCosts || []).filter((c) => c.id !== btn.dataset.delFixed);
      saveState();
      salvarFinanceiroNoBanco().catch((e) => console.warn("Falha ao salvar financeiro no Firebase:", e));
      renderFinance();
      renderDashboard();
    }));

    entriesBody.querySelectorAll('[data-del-fin]').forEach((btn) => btn.addEventListener('click', () => {
      state.finance.entries = (state.finance.entries || []).filter((e) => e.id !== btn.dataset.delFin);
      saveState();
      salvarFinanceiroNoBanco().catch((e) => console.warn("Falha ao salvar financeiro no Firebase:", e));
      renderFinance();
      renderDashboard();
    }));
  }

  // ====== DASHBOARD ======
  function ensureDashboardOrdersSeeds() {
    ensureOrdersSeeds();
    state.orders = state.orders || [];
    if (state.orders.length) return;
    const now = new Date();
    const mk = (d, status, nome, valor, lucro, corte, mont, idx) => ({
      id: crypto?.randomUUID?.() || String(Date.now() + Math.random()),
      orderNumber: `PED-${String(idx + 1).padStart(4, "0")}`,
      clienteNome: nome,
      canal: "Shopee",
      status,
      valorTotal: valor,
      custoTotal: Math.max(0, valor - lucro),
      lucroTotal: lucro,
      minutosCorte: corte,
      minutosMontagem: mont,
      dataPedido: new Date().toISOString().slice(0,10),
      dataEntrega: new Date(now.getFullYear(), now.getMonth(), now.getDate() + d).toISOString().slice(0,10),
      itens: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    });
    state.orders = [
      mk(-2, "Aprovado", "Pedido Festa Safari", 890, 320, 130, 80, 0),
      mk(-1, "Em Produ√ß√£o", "Topo de Bolo Premium", 420, 170, 95, 50, 1),
      mk(0, "Or√ßamento", "Lembrancinhas Dino", 0, 0, 60, 40, 2),
      mk(0, "Finalizado", "Painel Nome em MDF", 650, 250, 110, 70, 3),
      mk(0, "Entregue", "Kit Mesvers√°rio", 540, 220, 85, 40, 4),
    ];
  }

  function getDashboardData() {
    const delivered = (state.orders || []).filter((o) => o.status === "Entregue");
    const month = new Date().getMonth();
    const year = new Date().getFullYear();
    const deliveredMonth = delivered.filter((o) => {
      const dt = new Date((o.createdAt || `${o.dataEntrega || ""}T00:00:00`) || Date.now());
      return dt.getMonth() === month && dt.getFullYear() === year;
    });

    const receitaMes = deliveredMonth.reduce((acc, o) => acc + (n(o.valorTotal) ?? 0), 0);
    const lucroMes = deliveredMonth.reduce((acc, o) => acc + (n(o.lucroTotal) ?? 0), 0);
    const pedidosAbertos = (state.orders || []).filter((o) => o.status !== "Entregue").length;
    const producaoPendente = (state.orders || []).filter((o) => !["Finalizado", "Entregue"].includes(o.status)).length;
    const mdfDisponivel = (state.inventoryItems || []).filter((i) => i.tipo === "MDF").reduce((acc, i) => acc + (n(i.quantidadeAtual) ?? 0), 0);

    const hoje = new Date();
    const inicio = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
    const fim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate() + 1);
    const pedidosHoje = (state.orders || []).filter((o) => {
      const dt = new Date((o.dataEntrega || o.createdAt || "") + (o.dataEntrega ? "T00:00:00" : ""));
      return dt >= inicio && dt < fim;
    });
    const corteHoje = pedidosHoje.reduce((acc, o) => acc + (n(o.minutosCorte) ?? 0), 0);
    const montagemHoje = pedidosHoje.reduce((acc, o) => acc + (n(o.minutosMontagem) ?? 0), 0);
    const capacidadeDia = 480;
    const capacidadeUsada = ((corteHoje + montagemHoje) / capacidadeDia) * 100;

    const estoqueCritico = (state.inventoryItems || []).filter((i) => (n(i.quantidadeAtual) ?? 0) <= (n(i.estoqueMinimo) ?? 0));
    const topProdutos = (state.products || [])
      .slice()
      .sort((a, b) => (n(b.lucro) ?? 0) - (n(a.lucro) ?? 0))
      .slice(0, 5);

    const fin = financeMonthData();
    return { receitaMes, lucroMes, pedidosAbertos, producaoPendente, mdfDisponivel, corteHoje, montagemHoje, capacidadeDia, capacidadeUsada, estoqueCritico, topProdutos, fin };
  }

  function renderDashboard() {
    const cardsEl = document.getElementById("dashMainCards");
    if (!cardsEl) return;
    const data = getDashboardData();

    const cards = [
      { icon: "üí∏", label: "Entrada real recebida", value: fmtBRL(data.fin.entradaRecebida), sub: "Movimentos recebidos no m√™s" },
      { icon: "üßæ", label: "Pagamentos pendentes", value: fmtBRL(data.fin.pagamentoPendente), sub: "Sa√≠das em aberto" },
      { icon: "üè¢", label: "Custos fixos mensais", value: fmtBRL(data.fin.fixedCosts), sub: "Custos recorrentes cadastrados" },
      { icon: "üí∞", label: "Fluxo de caixa", value: fmtBRL(data.fin.fluxoCaixa), sub: "Entradas recebidas - sa√≠das pagas" },
      { icon: "üìâ", label: "Lucro real do m√™s", value: fmtBRL(data.fin.lucroReal), sub: "Fluxo de caixa - custos fixos" },
    ];

    cardsEl.innerHTML = cards.map((c) => `<div class="dashboard-card"><div class="label">${c.icon} ${c.label}</div><div class="value">${c.value}</div><div class="sub">${c.sub}</div></div>`).join("");

    const statusCols = ["Or√ßamento", "Aprovado", "Em Produ√ß√£o", "Finalizado", "Entregue"];
    document.getElementById("dashKanban").innerHTML = statusCols.map((status) => {
      const items = (state.orders || []).filter((o) => o.status === status).slice(0, 4);
      return `<div class="kan-col"><h3>${status} (${items.length})</h3>${items.map((i) => `<div class="kan-item">${i.clienteNome || "Pedido"}<br><b>${fmtBRL(i.valorTotal || 0)}</b></div>`).join("") || '<div class="muted">Sem itens</div>'}</div>`;
    }).join("");

    document.getElementById("dashProducao").innerHTML = `
      <div class="metric-line"><span>Minutos de corte programados</span><b>${fmtNum(data.corteHoje, 0)} min</b></div>
      <div class="metric-line"><span>Minutos de montagem</span><b>${fmtNum(data.montagemHoje, 0)} min</b></div>
      <div class="metric-line"><span>Capacidade di√°ria da m√°quina</span><b>${fmtNum(data.capacidadeDia, 0)} min</b></div>
      <div class="metric-line"><span>% capacidade usada</span><b>${fmtNum(data.capacidadeUsada, 1)}%</b></div>
      <div class="capacity-bar"><div class="capacity-fill" style="width:${Math.min(100, Math.max(0, data.capacidadeUsada))}%"></div></div>
    `;

    const crit = document.getElementById("dashEstoqueCritico");
    if (!data.estoqueCritico.length) crit.innerHTML = '<div class="note">‚úÖ Nenhum item cr√≠tico no momento.</div>';
    else crit.innerHTML = data.estoqueCritico.map((i) => `<div class="alert-item">‚ö† ${i.nome} baixo: ${fmtNum(i.quantidadeAtual ?? 0, i.tipo === "MDF" ? 2 : 0)} (m√≠nimo ${fmtNum(i.estoqueMinimo ?? 0, i.tipo === "MDF" ? 2 : 0)})</div>`).join("");

    const top = document.getElementById("dashTopProdutos");
    if (!data.topProdutos.length) top.innerHTML = '<div class="muted">Cadastre produtos para ver o ranking.</div>';
    else top.innerHTML = data.topProdutos.map((p, idx) => `<div class="profit-item"><span>${idx+1}. ${p.nome || p.sku || "Produto"}</span><b>${fmtBRL(p.lucro ?? 0)}</b></div>`).join("");
  }


  // ====== PARAMETROS ======
  function loadParamsUI() {
    const p = state.params;
    document.getElementById("p_laser").value = p.custoHoraLaser ?? "";
    document.getElementById("p_mao").value = p.custoMaoObra ?? "";
    document.getElementById("p_over").value = p.overhead ?? "";
    document.getElementById("p_emb").value = p.embalagem ?? "";
    document.getElementById("p_perdas").value = p.perdasPct ?? "";
    document.getElementById("p_margem").value = p.margemDesejada ?? "";
    document.getElementById("p_tax_shopee").value = p.taxas?.["Shopee"] ?? "";
    document.getElementById("p_tax_ml").value = p.taxas?.["Mercado Livre"] ?? "";
    document.getElementById("p_tax_tt").value = p.taxas?.["TikTok"] ?? "";
  }

  function saveParamsFromUI() {
    const p = state.params;
    p.custoHoraLaser = n(document.getElementById("p_laser").value) ?? 0;
    p.custoMaoObra = n(document.getElementById("p_mao").value) ?? 0;
    p.overhead = n(document.getElementById("p_over").value) ?? 0;
    p.embalagem = n(document.getElementById("p_emb").value) ?? 0;
    p.perdasPct = n(document.getElementById("p_perdas").value) ?? 0;
    p.margemDesejada = n(document.getElementById("p_margem").value) ?? 0;
    p.taxas = {
      "Shopee": n(document.getElementById("p_tax_shopee").value) ?? 0,
      "Mercado Livre": n(document.getElementById("p_tax_ml").value) ?? 0,
      "TikTok": n(document.getElementById("p_tax_tt").value) ?? 0,
    };
    saveState();
    syncSettingsDebounced();
    calcSim();
  }

  document.getElementById("btnSalvarParams").addEventListener("click", saveParamsFromUI);
  ["p_laser","p_mao","p_over","p_emb","p_perdas","p_margem","p_tax_shopee","p_tax_ml","p_tax_tt"].forEach(id => {
    document.getElementById(id).addEventListener("input", saveParamsFromUI);
  });

  function ensureFinanceSeeds() {
    state.finance = state.finance || {};
    state.finance.fixedCosts = Array.isArray(state.finance.fixedCosts) ? state.finance.fixedCosts : [];
    state.finance.entries = Array.isArray(state.finance.entries) ? state.finance.entries : [];
  }

  document.getElementById('btnAddFixedCost').addEventListener('click', () => {
    const description = document.getElementById('finFixedDesc').value.trim();
    const value = n(document.getElementById('finFixedValue').value) ?? 0;
    if (!description) return alert('Informe a descri√ß√£o do custo fixo.');
    if (value <= 0) return alert('Informe um valor v√°lido.');
    state.finance.fixedCosts.unshift({ id: crypto?.randomUUID?.() || String(Date.now()), description, value, createdAt: new Date().toISOString() });
    document.getElementById('finFixedDesc').value = '';
    document.getElementById('finFixedValue').value = '';
    saveState();
    salvarFinanceiroNoBanco().catch((e) => console.warn("Falha ao salvar financeiro no Firebase:", e));
    renderFinance();
    renderDashboard();
  });

  document.getElementById('btnAddFinanceEntry').addEventListener('click', () => {
    const type = document.getElementById('finType').value;
    const description = document.getElementById('finDesc').value.trim();
    const value = n(document.getElementById('finValue').value) ?? 0;
    const date = document.getElementById('finDate').value || new Date().toISOString().slice(0,10);
    const status = document.getElementById('finStatus').value;
    if (!description) return alert('Informe a descri√ß√£o do lan√ßamento.');
    if (value <= 0) return alert('Informe um valor v√°lido.');
    state.finance.entries.unshift({ id: crypto?.randomUUID?.() || String(Date.now()+Math.random()), type, description, value, date, status, createdAt: new Date().toISOString() });
    document.getElementById('finDesc').value = '';
    document.getElementById('finValue').value = '';
    saveState();
    salvarFinanceiroNoBanco().catch((e) => console.warn("Falha ao salvar financeiro no Firebase:", e));
    renderFinance();
    renderDashboard();
  });

  // ====== BACKUP ======
  document.getElementById("btnExport").addEventListener("click", () => {
    const payload = JSON.stringify(state, null, 2);
    const blob = new Blob([payload], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "backup_precificacao_mdf_laser.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("btnImport").addEventListener("click", () => {
    try {
      const raw = document.getElementById("importBox").value.trim();
      if (!raw) return alert("Cole um JSON primeiro.");
      const obj = JSON.parse(raw);
      if (!obj.woods || !obj.params) return alert("JSON inv√°lido: faltam campos.");
      state = {
        woods: Array.isArray(obj.woods) ? obj.woods : structuredClone(DEFAULT_DATA.woods),
        params: obj.params || structuredClone(DEFAULT_DATA.params),
        sim: obj.sim || structuredClone(DEFAULT_DATA.sim),
        products: Array.isArray(obj.products) ? obj.products : structuredClone(DEFAULT_DATA.products),
        priceHistory: Array.isArray(obj.priceHistory) ? obj.priceHistory : [],
        inventoryItems: Array.isArray(obj.inventoryItems) ? obj.inventoryItems : [],
        inventoryMovements: Array.isArray(obj.inventoryMovements) ? obj.inventoryMovements : [],
        dashboardOrders: Array.isArray(obj.dashboardOrders) ? obj.dashboardOrders : [],
        orders: Array.isArray(obj.orders) ? obj.orders : [],
        productionOrders: Array.isArray(obj.productionOrders) ? obj.productionOrders : [],
        finance: {
          fixedCosts: Array.isArray(obj.finance?.fixedCosts) ? obj.finance.fixedCosts : [],
          entries: Array.isArray(obj.finance?.entries) ? obj.finance.entries : [],
        },
      };
      saveState();
      syncSettingsDebounced();
      salvarPedidosNoBanco().catch((e) => console.warn("Falha ao salvar pedidos no Firebase:", e));
      salvarFinanceiroNoBanco().catch((e) => console.warn("Falha ao salvar financeiro no Firebase:", e));
      // recarregar tudo
      loadSimInputsFromState();
      loadParamsUI();
      renderWoods();
      fillProductWoodSelect();
      renderProducts();
      resetOrderForm();
      renderOrders();
      renderHistorico();
      ensureInventorySeeds();
      ensureFinanceSeeds();
      renderInventory();
      renderFinance();
      carregarProdutosDoBanco();
      carregarEstoqueDoBanco();
      calcSim();
      alert("Importado com sucesso!");
    } catch(e) {
      alert("Falha ao importar: " + e.message);
    }
  });

  document.getElementById("btnReset").addEventListener("click", () => {
    if (!confirm("Resetar tudo para o padr√£o da planilha?")) return;
    state = structuredClone(DEFAULT_DATA);
    saveState();
    syncSettingsDebounced();
    salvarPedidosNoBanco().catch((e) => console.warn("Falha ao salvar pedidos no Firebase:", e));
    salvarFinanceiroNoBanco().catch((e) => console.warn("Falha ao salvar financeiro no Firebase:", e));
    loadSimInputsFromState();
    loadParamsUI();
    renderWoods();
    fillProductWoodSelect();
    renderProducts();
    renderHistorico();
    ensureInventorySeeds();
    ensureFinanceSeeds();
    renderInventory();
    renderFinance();
    carregarProdutosDoBanco();
    carregarEstoqueDoBanco();
    calcSim();
  });

  // ====== INIT ======
  loadSimInputsFromState();
  loadParamsUI();
  renderWoods();
  fillProductWoodSelect();
  resetProdutoForm();
  ensureInventorySeeds();
  ensureDashboardOrdersSeeds();
  ensureFinanceSeeds();
  document.getElementById('finDate').value = new Date().toISOString().slice(0,10);
  resetOrderForm();
  renderOrders();
  renderProducts();
  renderHistorico();
  renderInventory();
  renderDashboard();
  renderFinance();
  carregarProdutosDoBanco();
  carregarEstoqueDoBanco();
  carregarConfiguracoesDoBanco().catch((e) => console.warn("Falha ao carregar configura√ß√µes do Firebase:", e));
  carregarPedidosDoBanco().catch((e) => console.warn("Falha ao carregar pedidos do Firebase:", e));
  carregarFinanceiroDoBanco().catch((e) => console.warn("Falha ao carregar financeiro do Firebase:", e));
  calcSim();
</script>
</body>
</html>
